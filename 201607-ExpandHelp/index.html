<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>コロンブス日和 - ExpandHelp</title>
    <style type="text/css">
      body {
        background-color:#ffffff;
        font-size:12;
        font-family: "Hiragino Kaku Gothic ProN","メイリオ", "sans-serif";
      }
      a { text-decoration: none; }
      li.bold { font-weight: bold; }
      div.body { width:340pt; }
      div.left { float:left; width:10%; font-weight:bold;}
      div.right { width:50%;}
      h1 { background-color:#4d4; padding:8pt;}
      code { background-color:#eee; }
      pre { background-color:#eee; }
    </style>
    <script type="text/javascript">
    //setTimeout("location.reload()",1000*5);
    </script>

  </head>

  <body>
    <div class='body'>
      <h1>コロンブス日和 - ExpandHelp</h1>
      
      今回は、オンラインヘルプやマニュアルに関連するイライラを解決できる
      「ExpandHelp」というシステムを紹介します。
      
      <h2>ヘルプの憂鬱</h2>
      
      たいていの複雑なシステムにはオンラインヘルプやマニュアルが用意されているものですが、
      パソコンやアプリケーションの解説本が大量に売られているところを見ると、
      ヘルプやマニュアルは充分役にたってはいないようです。
      
      <p/>
      ヘルプが利用されない最大の理由は
      <b>必要な項目がみつからない</b>
      ことでしょう。
      
      たとえばMacを米国時間に設定したいと思って「米国時間」で検索すると
      下のような謎の項目が表示されます。
      
      <blockquote>
        <img src="https://gyazo.com/1d1f4a6f960405a4011cb9fa678e168d.png" width=250>
      </blockquote> 
      
      これではわけがわからないので
      「時間」で検索すると
      より多くの項目が表示されますが、
      米国時間の設定には関係なさそうです。
      
      <blockquote>
        <img src="https://gyazo.com/027aa92aeb12308cbc5ebfe608cc61b4.png" width=250>
      </blockquote>
      
      「時刻」や「時計」で検索すれば「「日付と時刻」環境設定」という項目が
      みつかりますが、これで米国時間に設定できるのかはよくわかりませんし、
      そもそも「米国時間」や「時間」でも検索できるべきではないでしょうか。
            
      <p/>
      必要な項目がみつかった場合でも、
      そこに記述されている方法は
      <b>自分で実行する</b>必要があります。
        
      ユーザはMacを米国時間に設定したいだけであり、
      時刻やタイムゾーンを設定する一般的な方法を知りたいわけではないのにもかかわらず、
      ヘルプシステムは一般的なやり方しか教えてくれませんから、
      ユーザは自分で環境設定パネルを開いて
      米国時間に設定する必要があります。
      
      <p/>
      このように、たいていのヘルプシステムは
      
      <ol>
        <li>ヘルプ項目がみつからない</li>
        <li>自分で操作が必要</li>
      </ol>
      
      という問題があることになりますが、
      
      一方で最近は普通にWeb検索すればそれなりに有用情報がみつかることが多いため、
      ヘルプシステムへの期待が低くなってしまっているのだと思われます。
      
      <h2>ExpandHelp</h2>
      
      Web検索に苦労することが少なくなってきたのは、
      検索エンジンの性能が向上したこともさることながら、
      情報の量がすごい勢いで増えてきたことによる影響も大きいでしょう。
      どこかのブログに「Macの時計を米国時間に設定する方法」という記事があれば
      普通に「Mac 米国時間」で検索すればみつかる可能性が高いようにですが、
      <b>様々な表現で情報が表現されていれば検索に成功する可能性が高くなる</b>
      といえるでしょう。
      
      ExpandHelpは、
      どんな検索語からでもヘルプエントリがみつかるように
      様々な表現でヘルプ内容を表現し、
      かつユーザの要求をすぐ実行できるようにするシステムです。
      
      <h3>Generate and Filter</h3>
      
      <p/>
      パズルを解く方法として
      「<b>Generate and Test</b>」と呼ばれるアルゴリズムがあります。
      たとえば「数独」を解こうとする場合、
      理屈で推論して空きを埋めていくのではなく、
      あらゆる数字の組み合わせを<b>生成</b>して順番に<b>試して</b>みれば、
      時間はかかるかもしれませんが必ず最終的に答がみつかるはずです。
      
      これはひどく効率が悪いやり方に見えますが、
      明らかに間違っている組み合わせを早目に無視するような工夫をすれば、
      このような簡単なアルゴリズムでもうまくパズルを解くことができる場合があります。
      
      ヘルプの検索でもこれに似た方法を使うことができます。
      
      <p/>
      ヘルプデータやWebをキーワード検索を行なう場合、
      普通は検索対象は固定であり、
      それを検索するためのキーワードをユーザが工夫するのが常識になっています。

      たとえば「時間」というキーワードを使って
      米国時間に関連した情報を探すことに失敗した場合は
      「時刻」や「タイムゾーン」のような別のキーワードで
      再検索を試みるのが普通でしょう。
      これは結果的に
      「<code>(時間|時刻|タイムゾーン)</code>」
      のような正規表現で検索したのと同等ですから
      ユーザにとっては面倒な話ですが、
      Web検索でもファイル検索でもこういうやり方が常識になっているので
      これを特に苦痛だと思っていない人も多いかもしれません。
      
      <p/>
      しかし本当にユーザにとって便利なヘルプ情報を提供しようとするならば、
      ユーザに検索語を工夫させるのではなく、
      「米国時間にセット」でも「タイムゾーンを設定」でも
      ヘルプエントリを検索できるように、
      あらゆる表現でデータを用意しておく方が親切です。

      たとえばヘルプシステム側に
      「<code>タイムゾーンを(米国|英国)(時間|時刻)に(設定|セット|変更)する</code>」
      のような正規表現を用意しておき、
      これを使ってあらゆるヘルプ表現の組み合わせを<b>生成</b>し、
      ユーザの与えた検索語で<b>フィルタリング</b>することにすれば、
      「米国時間にセット」でも「タイムゾーンを設定」でもヘルプがみつかるようになるはずです。
      
      <p/>
      Generate and Testであらゆる解の候補を生成してから解のチェックをするのと同じ要領で、
      あらゆる説明文字列のパタンを<b>生成</b>しつつ
      その中でユーザの検索文字列とマッチするもので<b>フィルタリング</b>を行なう
      「<b>Generate and Filter</b>」方式を使えば、
      ユーザはキーワードについて頭を使うことなく検索に成功する可能性が高まります。
      このような手法をExpandHelpと呼ぶことにします。

      <p/>
      正規表現的な検索パタンをユーザに考えさせるのではなく、
      システムの方で最初から用意しておくというのが
      ExpandHelpの特徴です。

      展開されたデータは巨大になってしまう可能性がありますが、
      最近のパソコンでは多少大きなデータを利用しても問題ありませんし、
      Generate and Testの場合と同じように実装を工夫すれば
      実際にすべての文字列を展開せずに検索を行なうこともできます。

      <h3>ヘルプ項目の実行</h3>
      
      ヘルプ項目の検索に成功した場合でも、
      記事を参照しながらユーザが自分で操作を行なう必要があります。
      この手間をなくすには、
      <b>ユーザが指定した検索キーワードをもとにして、
      ユーザの意図に合致する操作コマンドをシステムが生成して実行できる</b>
      ようにすればよいでしょう。
      
      <p/>
      「米国時間」でヘルプ検索に成功してユーザの意図どおりの結果が出た場合、
      ユーザの意図は正しく検索システムに伝わっていることになりますから、
      そのままシステムに実行を指示することができます。
      タイムゾーンを設定する<code>timezone</code>というコマンドが存在したとすると、
      ヘルプ文字列に対して
      「<code>timezone $1</code>」
      のようなコマンドパタンを登録しておいて「米国」のようなパラメタを代入すれば、
      <code>timezone 米国</code>
      を起動することができます。

      <h2>Mac版ExpandHelp</h2>
      
      このような考えにもとづいて、
      Mac版のExpandHelpを試作してみました。
      MacのExpandHelpはメニューバーに常駐するアプリケーションで、
      キーワードを入力するとそれに関連したヘルプが表示されます。
            
      <blockquote>
        <img src="http://gyazo.com/43d82e015388a040ce9b854ab064e60f.png" width=300>
      </blockquote>
      
      たとえば「3:45」と入力すると、
      3:45という時刻に関連するコマンドがメニューに表示されます。
      
      <blockquote>
        <img src="http://gyazo.com/c9c5cc8b59bb34c7867c19a0f55ef7d5.png" width=300>
      </blockquote>
      
      ここで「時刻を3:45にセットする」を選ぶと
      <code>date</code>コマンドが実行されて
      システムの時刻が3:45にセットされます。
      
      <p/>
      ExpandHelpのヘルプデータは以下のような配列として表現されています。
      
      <blockquote>
        <img src="http://gyazo.com/1e55a71c044a5121d51fdfe44e648feb.png" width=400>
      </blockquote>
      
      「<code>(時計|時間|時刻)を(0|1|2|3|4|5|6|7|8|9|10|11|12):(0|1|2|3|4|5)(0|1|2|3|4|5|6|7|8|9)(AM|PM)に(セットする|設定する|あわせる)</code>」
      を展開したパタンのうち<code>3:45</code>にマッチするものが表示され、
      「<code>時刻を3:45にセットする</code>」を選択すると
      <code>setdate(3,4,5)</code>
      が実行されます。
      
      <h2>GitHelp</h2>
      
      Mac版のExpandHelpは興味深いシステムだったのですが、
      毎日使うようなものではないにもかかわらず
      ヘルプデータを用意するのが面倒なので
      結局あまり使わなくなってしまいました。
            
      万人向けの一般的なヘルプデータを用意するのは大変ですが、
      自分が毎日のように使う複雑なシステムの利用を
      助けてくれるシステムならばもっと嬉しいだろうと考え、
      Gitのヘルプシステム「GitHelp」を作ってみました。
      
      <p/>
      バージョン管理システム「Git」は
      最近プログラマの間で広く使われていますが、
      基本概念もコマンド構成も複雑なのが難点です。
      gitには100個以上のサブコマンドが存在するうえに
      各サブコマンドの仕様も複雑です。
      バージョン履歴のログを表示するためよく使われる
      「<code>git log</code>」コマンドのマニュアルページは
      2000行近くもあり、
      このコマンドひとつだけでも
      機能を理解するのは困難になっています。
            
      <p/>
      Gitのコマンドについてある程度理解しているユーザでも、
      ちょっと標準と異なることをやりたい場合には
      Gitの機能をどう組み合わせて使えば良いのか悩むことがあります。
      ユーザの様々な要求に対して良い解決手順を記述しておき、
      ExpandHelpの要領で検索できるようにしておけば便利です。
      GitHelpはGitに関するExpandHelpをコマンドラインから使えるようにしたシステムです。
      
      <p/>
      たとえば「昨日のREADME.mdを見たい」と思っても
      標準的なGitコマンドや引数でこれを実行することは簡単ではありません。
      <code>git log</code>
      コマンドでREADME.mdの編集履歴を参照し、
      昨日のコミットIDをみつけて
      <code>git cat-file -p (コミットID):README.md</code>
      のようなコマンドを起動すれば良いのですが、
      これはなかなか面倒な作業ですし操作を覚えるのは大変です。
      
      実はコミットIDを取得しなくても
      <code>git cat-file -p "@{1 days ago}":README.md</code>
      というコマンドで実行できるのですが、
      こういうマイナーな機能があることを知っているユーザは多くないでしょう。
      「昨日のファイルを見たい」のような単純な要求に対しても
      難しいコマンドや複雑な引数が必要になるのは困りものです。
      
      <p/>
      GitHelpでは、
      「<code>昨日の(#{pat})ファイルを表示する</code>」
      という説明パタンと
      「<code>git cat-file -p "@{yesterday}":#{$1}</code>」
      というコマンドパタンのペアを用意しておくことにより、
      「<code>昨日</code>」「</code>README</code>」のようなキーワードを指定するだけで
      必要なコマンドを検索してリストすることができます。
      
      <pre>
$ githelp 昨日 AD
[0] 昨日の「README.md」ファイルを表示する
   % git cat-file -p "@{yesterday}":README.md
[1] 昨日の「data/adddelete.rb」ファイルを表示する
   % git cat-file -p "@{yesterday}":data/adddelete.rb
[2] 昨日の「data/afteradd.rb」ファイルを表示する
   % git cat-file -p "@{yesterday}":data/afteradd.rb
$
      </pre>
      
      ここではコマンドの候補がリストされているだけですが、
      <code>-x</code>
      オプションを指定すると候補を選択して実行させることができます。

      <pre>
$ githelp 昨日 AD -x0
# GitHelp
      
**Gitのコマンドの使いこなしを支援**
      
### 解決したい問題
...
      </pre>

      GitHelpのヘルプデータは以下のような配列になっています。
      各配列要素のの1行目がヘルプ文字列のパタンになっており、
      2行目がそれを実行するためのコマンド文字列になっています。
      
      <pre>
[
  [
    "昨日の「(#{files.join('|')})」ファイルを(表示する|見る)",
    'git cat-file -p "@{yesterday}":#{$1}'
  ],
  [
    "「(#{files.join('|')})」ファイルを(#{numbers.join('|')})日前の(もの|バージョン)と比較する",
    'git diff HEAD "@{#{$2} days ago}" #{$1}'
  ],
  [
    "「(#{files.join('|')})」ファイルが(#{numbers.join('|')})日前から(変化した|変わった)ところを(表示する|見る)",
    'git diff HEAD "@{#{$2} days ago}" #{$1}'
  ],
  [
    "「(#{files.join('|')})」ファイルをひとつ前のコミットと比較する",
    'git diff HEAD^ #{$1}'
  ],
  [
    "「(#{files.join('|')})」ファイルをふたつ前のコミットと比較する",
    'git diff HEAD^^ #{$1}'
  ],
  [
    "(#{numbers.join('|')})日前から(変化した|変わった|変更された)ファイルをリストする",
    'githelp-changed \'#{$1} days ago\''
  ],
  [
    "(#{numbers.join('|')})分前から(変化してない|変わってない|変わらない|変更されてない)ファイルをリストする",
    'githelp-unchanged \'#{$1} minutes ago\''
  ],
      </pre>
      
      <code>README.md</code>、<code>Rakefile</code>、...
      のようなファイルがGitに管理されている環境において
      ユーザが
      「<code>$ githelp 昨日 AD</code>」
      を実行すると、
      <code>files()</code>
      の結果が
      <code>['README.md', 'Rakefile', ...]</code>
      のような値になるので、
      最初のパタンは
      <code>"昨日の「(README.md|Rakefile|...)」ファイルを(表示する|見る)"</code>
      のようになります。
      この正規表現を展開した結果得られる文字列の中の
      「<code>昨日のREADME.mdファイルを表示する</code>」
      という文字列が
      ユーザの与えたキーワード「昨日」「AD」とマッチするので
      それに対応するコマンド
      「<code>git cat-file -p "@{yesterday}":README</code>」
      を実行できるようになります。

      <p/>
      このようにGitHelpでは、
      やりたいことの一部を示すだけで
      ヘルプ情報を検索し、実行まで行なうことができることがわかります。
      
      私はいまだにGitのコマンドがよくわかっていないのですが、
      GitHelpで練習していればコツがわかってくるのではないかと期待しています。

      <h2>ExpandHelpの実装</h2>
      
      今回はRubyで正規表現展開ライブラリ
      <code>re_expand</code>
      をまず実装し、それを使って
      ExpandHelpを実装しています。
      
      <p/>
      <code>a(b*|c*)</code>
      のような正規表現を展開するとき、
      前から順番に深さ優先で展開していくと
      <code>a</code>, <code>ab</code>, <code>abb</code>, <code>abbb</code>, ...
      といったパタンが生成されてしまい、
      永遠に
      <code>ac</code>
      のようなパタンが出てこないことになってしまいます。
      これを避けるため、
      <code>re_expand</code>
      では幅優先で展開を行なうようにしています。
      
      このため多少富豪的な実装になってしまっていますが、
      非常に大きな正規表現を指定しなければ大丈夫です。
      
      <p/>
      ExpandHelpはアイデア自体は単純なのですが、
      正規表現の展開が必要なので
      <code>re_expand</code>も含めると
      残念ながら実装はちょっと複雑になってしまいました。
      
      しかし、
      ヘルプなどの検索を行なうときに
      Generate and Testのような方法が有効だということに気付いたのは
      コロンブスの卵的だと思っています。
      
      GitHelpは実際毎日のGit活用に有用なので、
      ヘルプデータをもっと整備して毎日使っていこうと考えています。
      
      <p/>
      GitHelpは
      <a href="https://github.com/masui/GitHelp">https://github.com/masui/GitHelp</a>
      で公開しており、
      <code>gem install githelp</code>で簡単にインストールできるのでぜひご利用ください。
      
    </div>
  </body>
</html>


