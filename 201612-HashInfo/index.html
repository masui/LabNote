<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>コロンブス日和 - HashInfo</title>
    <style type="text/css">
      body {
        background-color:#ffffff;
        font-size:12;
        font-family: "Hiragino Kaku Gothic ProN","メイリオ", "sans-serif";
      }
      a { text-decoration: none; }
      li.bold { font-weight: bold; }
      div.body { width:340pt; }
      div.left { float:left; width:10%; font-weight:bold;}
      div.right { width:50%;}
      h1 { background-color:#4d4; padding:8pt;}
      code { background-color:#eee; }
      pre { background-color:#eee; }
    </style>
    <script type="text/javascript">
    //setTimeout("location.reload()",1000*5);
    </script>
  </head>

  <body>
    <div class='body'>
      <h1>コロンブス日和 - HashInfo</h1>

      以下のようなことをしたいと思ったことはないでしょうか?

      <ul>
	<li>同じファイルを複数持ってないかチェックしたい</li>
	<li>重要なファイルだけバックアップしたい</li>
	<li>自分のアイデアの日付を確実に記録しておきたい</li>
      </ul>

      実はこれらはすべてをひとつのやり方で解決することができます。

      このような要求はすべて、
      ファイルがユニークなものかどうかを判別することによって解決できるからです。

      <h2>HashInfo</h2> <!-- HashInfo.netを取得しておく? -->

      パソコンやWebには膨大なファイルがありますが、
      同じファイルが様々な場所に冗長に置かれていることも多いと思われます。
      私の場合、
      同じファイルを何度もダウンロードしてしまったり、
      写真や動画をいろんな場所にコピーしてしまったりすることがよくありますし、
      バックアップのつもりでコピーしたデータをさらに
      バックアップ対象にしてしまった結果、
      バックアップのバックアップ(のバックアップの...以下同様)
      のような無駄なデータを作ってしまうことすらあります。

      <!--
      どうでもいいムービーファイルを一瞬デスクトップに置いてしまう
      それが延々とバックアップされつづける
	-->

      <p/>
      こういう問題を防ぐためには、
      対象ファイルと同じファイルがすでに存在するか調べれば良いわけですが、
      すべてのファイルと中身を比較することは現実的ではありません。

      しかし、ファイルの「ハッシュ値」を利用すれば、
      あるファイルがユニークなものであるかを比較的簡単に判別することができます。

      <h3>ハッシュ関数とハッシュ値</h3>

      デジタルデータを一定サイズの数値に変換する関数を<b>ハッシュ関数</b>と呼び、
      計算された値をそのデータの<b>ハッシュ値</b>と呼びます。
      
      最近のプログラミング言語では<code>a['abc']</code>のような<b>連想配列</b>が使えるのが普通ですが、
      これを通常の計算機上に実装する場合、
      <code>"abc"</code>のような文字列に対してハッシュ関数を計算し、
      その数値を利用して通常の配列に変換するような手法がよく利用されています。

      <p/>
      ハッシュ値のサイズが小さい場合は
      異なるデータから同じハッシュ値が計算されてしまう(ハッシュ値が衝突する)ことがありますが、
      ある程度大きなハッシュ値を生成する適切なハッシュ関数を用意すれば、
      ハッシュ値が衝突する可能性はほぼゼロにすることができます。
      また、ハッシュ値からもとのデータを計算することもほぼ不可能にすることができます。

      <p/>
      ハッシュ関数は様々なものが考えられますが、
      現在はMD5やsha1というハッシュ関数が広く利用されています。

      このようなハッシュ関数は以下のような特徴をもつため、
      暗号などで広く利用されています...

      <ul>
	<li>同一のハッシュ値であるのに、そっくりだが実は異なるというようなメッセージの作成が不可能であること。</li>
	<li>ハッシュ値から、そのようなハッシュ値となるメッセージを得ることが(事実上)不可能であること（原像計算困難性）。</li>
	<li>同じハッシュ値となる、異なる2つのメッセージのペアを求めることが(事実上)不可能であること（強衝突耐性）。</li>
      </ul>

      今回は、
      ファイルから計算されるハッシュ値はすべて異なる、
      及び
      ハッシュ値からもとデータを計算することはできない
      という特徴を利用します。

      <p/>
      このようなファイルのハッシュ情報を利用する手法を総称して
      HashInfo
      と呼ぶことにします。

      <h2>HashInfoによるファイルの視覚化</h2>

      ハッシュ値の特徴を利用すれば、
      手持ちのすべてのファイルのハッシュ値をあらかじめ計算しておくことにより、
      あるファイルが別のところに既に存在するかを調べることができます。

      たとえば、
      <code>movies/abc.mp4</code>という動画と
      <code>backup/xyz.mp4</code>という動画のハッシュ値が同じであれば、
      abc.mp4とxyz.mp4は同じファイルであり、
      両方をバックアップする意味はないと考えられます。

      <p/>
      図1は、
      手持ちのパソコンのすべてのファイルのハッシュ値を計算し、
      それをTreemapという手法で視覚化してみたものです。
      同じファイルが複数ある場合、
      そのファイルを赤く表示しています。
      (研究室に所属していた池滝俊太氏の卒業論文による)

      <p/>
      池滝氏は整理が得意なのか、
      重複するファイルは多くはないようですが、
      それでもかなりの部分が赤くなっている(重複が多い)ことがわかります。

      <blockquote>
	<img src="https://gyazo.com/4418725289623822fa490081d48ec670.png" width=400><br>
	図1: 自分のパソコン内で重複しているものを赤く表示したもの
      </blockquote>

      ハッシュ情報を複数の人間で共有すれば、
      自分が持っているファイルを他人も持っていることがわかります。
      
      図2は、
      研究室の数人の学生に協力してもらって、
      他人のパソコンまで比較対象を広げて同じ計算をしてみたものです。
      多くの学生はMacを利用しているため、
      Macのシステムファイルは全員に共通であるため、
      図1に比べると左下部分が赤くなっています。

      <blockquote>
	<img src="https://gyazo.com/5124de74689ff55d53ffb3da92c1c636.png" width=400><br>
	図2: 他人とのファイル共有の視覚化
      </blockquote>

      このように、ハッシュ関数を利用すると
      自分が持っているファイルの素性がなんとなく見えてくるといえるでしょう。
      ファイルの中身をいくら調べてもこういうことはわからないわけですが、
      他のファイルや他人のファイルとの比較により
      ファイルの特徴が見えてくることになります。

      <h2>重要情報のバックアップ</h2>

      前述の方法を使うと、
      複数のマシンでHashInfoを計算すると、
      様々なマシンで同じファイルが共有されていることがわかります。
      システムファイルはアプリケーションファイルは
      明らかに多数のマシンで共有されているはずですが、
      あまり重要でない大きなファイルが
      いろんなマシンで共有されている可能性も高いと思われます。

      Node.jsでプログラム開発する場合、
      node_modulesの下にライブラリが沢山ダウンロードされますが、
      このようなファイルはバックアップをする必要はありません。

      ブラウザでWebからデータをダウンロードするとき、
      大きなアプリケーションのプログラムファイルも
      重要なファイルも
      同じフォルダに入ってしまうので
      広く配られてるファイルと重要なファイルの区別は難しいですが、
      HashiInfoを利用すると
      その違いは明白になるので、
      どのファイルが重要なのかが漠然とわかるようになります。

      一方、
      コンパイル結果やログファイルなどは
      重要ではないかもしれませんが
      他人が同じファイルを持っている可能性は低いと思われます。

      「他人と共有していない」「明らかに重要でない」
      という条件を満たすファイルだけをバックアップすることにしておけば、
      無駄なバックアップを防ぐことができるでしょう。
      
      <h2>ハッシュ値を利用した認証</h2>

      特許や論文になるかもしれない新しいアイデアを思いついたときなど、
      ある時点においてある情報を自分が持っていたことを証明したい場合があります。

      情報がいつ作成されたかを個人的に覚えておくためには
      ファイル作成時刻を記録しておけば良いのですが、
      ファイルの中身や作成時刻後から偽造できるので、
      確かにその時点でその情報が存在したということを他人に納得させることはできません。
      デジタル情報がいつ作成されたか証明するためには
      どうしても信用できる外部の誰かに認証してもらう必要があります。

      <p/>
      ある時点である書類が存在したことを証明するためには昔から
      「<a href="http://www.koshonin.gr.jp/a2.html">公証役場</a>」
      が利用されています。
      公証役場の業務のひとつに
      「確定日付の付与」
      というものがあります。
      これは、私文書に「確定日付」を付与し、
      その日にその文書が存在したことを証明するものです。

      <p/>
      デジタルデータを印刷して書類にしておけば、
      その存在を証明するために公証役場を利用することができますが、
      印を押してもらうためには
      情報を印刷して公証役場に持って行くのは面倒ですし費用もかかります。
      
      デジタル情報の存在を証明するためには
      最近は「<a href="http://www.koshonin.gr.jp/de2.html">電子公証システム</a>」
      を利用できるようになったので、
      公証役場に行かなくても
      公的な認証を得られるようになったことは朗報ですが、
      かなりの費用がかかってしまいます。

      <p/>
      ある時刻にあるデジタルデータが存在したことを証明する技術のことを
      <a href="http://www.imes.boj.or.jp/japanese/kinyu/2000/kk19-b1-4.pdf">デジタルタイムスタンプ</a>技術といいます。

      <p/>
      また、電子公証システムを利用する場合は
      証明したいデータの提示が必要ですが、
      情報が漏れることは心配かもしれません。

      その時点でその情報が存在することは証明したいけれども
      情報の中身は公開したくないかもしれません。

      <p/>
      たとえば、簡単で良いアイデアを思いついたとき、
      特許をとるまで内容は公開できませんが、
      そのアイデアをいつ誰が思いついたかは記録しておきたいでしょう。

      <p/>
      つまり
      「情報を持っていることは証明するが、情報そのものは公開しない」
      ことが必要になります。

      <h3>HashInfoによるデジタルタイムスタンプ</h3>

      生のデジタル情報の存在証明を行なうかわりに、
      その情報のハッシュ値の存在証明を行なうことにすれば、
      情報そのものを渡す必要がないのでより安全だと考えられます。

      たとえばある問題の解法を発見したとき、
      たとえば「問題Aの解法BをCが発見した」という文字列のハッシュ値
      (この場合XXXXXXX)を公証役場や電子公証サービスに登録しておけば、
      ハッシュ値からもとの文字列を計算することはほぼ不可能なので、
      文字列そのものを登録しなくても証明を行なうことができます。
      
      <h3>電子公証システムの問題点</h3>

      電子公証システム利用は高価であり利便性の問題もあるので、
      デジタルタイムスタンプ技術を提供する
      民間のサービスが出現しています。
      
      <p/>
      Seiko: https://www.seiko-cybertime.jp/product/easy_time_stamp/ <br>
      アマノ: http://www.e-timing.ne.jp/product/timestamp/characteristic/typet/
      <p/>

      しかしこれらのサービスを使う場合、
      大事なデータを民間企業に渡すことになるので心配ですし、
      サービスがどれほど信頼できるかわかりません。
      実際、こういうサービスの多くは現在運営を中止してしまったものが多いですし
      10年後/20年後も確実に利用できる保証はありません。

      <h3>通常サービスを利用する</h3>

      電子公証サービスや民間のデジタルタイムスタンプサービスを利用しなくても、
      一般的なブックマークサービスを利用することによって
      無料でハッシュ情報の存在を証明できるかもしれません。

      <p/>
      たとえば前の例の場合、
      <code>http://example.com/XXXXXX</code>
      というURLを
      はてブのようなブックマーク登録サイトや
      任意のブログサービスに記録しておけば、
      XXXXXXという情報がどの時点で存在していたかが
      それらのサイトで公開されることになりますから、
      「問題A...」という情報がある時点存在したことが証明されることになります。

      ひとつのサービスだけに登録すると
      そのサイトの管理者に偽造される可能性もあるでしょうが、
      関連のない沢山のサービスに同じ情報を登録しておけば、
      すべてを偽造することは不可能と考えるられるので、
      その情報がその時間に存在したことを
      かなり確実に主張できると思われます。

      <p/>
      つまり、時刻を証明したい情報があるときは必ず
      以下の手順をとることにしておけば、
      確実にデータの存在証明を行なうことができるでしょう。

      <ul>
	<li>情報を秘密の場所に格納する</li>
	<li>情報のハッシュ値を複数のサイトに登録する</li>
      </ul>

      たとえば、普通のテキストエディタを使っている場合でも、
      気合いを入れてセーブした場合には
      上記の処理を自動的に行なうようにしておけばいいかもしれません。

      秘密にしておくべきもとデータ安全な場所に格納しておけばよいでしょうし、
      暗号化したデータをクラウドなどにもセーブしておけば
      さらに安全かもしれません。

      <h2>HashInfoの共有</h2>

      これらに述べたように、
      多数人間でファイルのハッシュ値を共有するデータベースがあれば
      いろいろな用途に利用できることが期待できます。
      
      素性が怪しいファイルを他の誰かが持っていることがわかれば
      問題になる可能性もあるので
      誰がどのハッシュを持っているかという情報は隠す必要があるでしょう。

      しかし、プライバシやセキュリティに充分配慮すれば
      HashInfoは有用なはずです。
      
      
    </div>
  </body>
</html>
