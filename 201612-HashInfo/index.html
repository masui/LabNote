<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>コロンブス日和 - HashInfo</title>
    <style type="text/css">
      body {
        background-color:#ffffff;
        font-size:12;
        font-family: "Hiragino Kaku Gothic ProN","メイリオ", "sans-serif";
      }
      a { text-decoration: none; }
      li.bold { font-weight: bold; }
      div.body { width:340pt; }
      div.left { float:left; width:10%; font-weight:bold;}
      div.right { width:50%;}
      h1 { background-color:#4d4; padding:8pt;}
      code { background-color:#eee; }
      pre { background-color:#eee; }
    </style>
    <script type="text/javascript">
    //setTimeout("location.reload()",1000*5);
    </script>
  </head>

  <body>
    <div class='body'>
      <h1>コロンブス日和 - HashInfo</h1>

      以下のような作業をやりたいと思ったことはないでしょうか?

      <ul>
	<li>同じファイルがあちこちに無いかチェックしたい</li>
	<li>重要なファイルだけバックアップしたい</li>
	<li>自分のアイデアを日付つきで記録したい</li>
      </ul>

      実はこのような仕事は、
      ひとつの単純な方法を使って実行することができます。

      <h2>HashInfo</h2>

      パソコンやWebには膨大なファイルがありますが、
      同じファイルがあちこちに冗長に置かれていることも多いでしょう。

      私の場合、
      同じファイルを何度もダウンロードしてしまったり
      写真や動画をいろんな場所にコピーしてしまったりすることがよくありますし、
      バックアップのつもりでコピーしたデータをさらに
      バックアップ対象にしてしまった結果、
      バックアップのバックアップ(のバックアップの...以下同様)
      のような無駄なデータを作ってしまうことすらあります。

      <p/>
      こういう問題を防ぐためには、
      同じファイルがすでに別のところに存在するか調べれば良いわけですが、
      すべてのファイルの中身を比較することは現実的ではありません。

      しかし、ファイルの「ハッシュ値」を利用すれば、
      あるファイルが独自の(ユニークな)ものなのかどうかを
      比較的簡単に判別することができます。

      <h3>ハッシュ関数とハッシュ値</h3>

      デジタルデータを一定サイズの数値に変換する関数を<b>ハッシュ関数</b>と呼び、
      計算された値をそのデータの<b>ハッシュ値</b>と呼びます。
      
      最近のプログラミング言語では<code>a['abc']</code>のような<b>連想配列</b>が使えるのが普通ですが、
      これを通常の計算機上に実装する場合、
      <code>"abc"</code>のような文字列に対してハッシュ関数を計算し、
      その数値を添字として利用することによって
      通常の配列と同じように扱う手法がよく利用されています。

      <p/>
      ハッシュ値のサイズが小さい場合は
      異なるデータから同じハッシュ値が計算されてしまう(ハッシュ値が衝突する)ことがありますが、
      ある程度大きなハッシュ値を生成する適切なハッシュ関数を用意すれば、
      ハッシュ値が衝突する可能性はほぼゼロにすることができます。
      また、ハッシュ値からもとのデータを計算することもほぼ不可能にすることができます。

      <p/>
      ハッシュ関数は様々なものが考えられますが、
      現在はMD5やsha1というハッシュ関数が広く利用されています。

      このようなハッシュ関数は以下のような特徴をもつため、
      暗号化アルゴリズムなどで広く利用されています。

      <ul>
	<li>ハッシュ値からもとのデータを知ることはできない</li>
	<li>異なるデータのハッシュ値が同じ値になることはない</li>
      </ul>

      ファイルデータから計算される
      ハッシュ値の情報(HashInfo)をうまく利用することにより、
      最初に述べたような様々な有用な機能を実現することができます。

      <h2>重複ファイルの視覚化</h2>

      ハッシュ値の特徴を利用すれば、
      手持ちのすべてのファイルのハッシュ値をあらかじめ計算しておくことにより、
      あるファイルが別のところに既に存在するかを調べることができます。

      たとえば、
      <code>movies/abc.mp4</code>という動画と
      <code>backup/xyz.mp4</code>という動画のハッシュ値が同じであれば、
      abc.mp4とxyz.mp4は同じファイルだということがわかるので、
      たとえば両方をバックアップする意味はないと判断することができます。

      <p/>
      図1は、
      手持ちのパソコンのすべてのファイルのハッシュ値を計算し、
      それをTreemapという手法で視覚化してみたものです。
      同じファイルが複数ある場合、
      そのファイルを赤く表示しています。
      (研究室に所属していた池滝俊太氏の卒業論文による)

      <p/>
      池滝氏は整理が得意なのか、
      重複するファイルは多くはないようですが、
      それでもかなりの部分に色がついている(ファイルが重複している)ことがわかります。

      <blockquote>
	<img src="https://gyazo.com/4418725289623822fa490081d48ec670.png" width=400><br>
	図1: 自分のパソコン内で重複しているものを赤く表示したもの
      </blockquote>

      ハッシュ情報を複数の人間で共有すれば、
      自分が持っているファイルを
      他の人も持っているかどうかがわかります。
      
      図2は、
      研究室の数人の学生に協力してもらって、
      他人のパソコンまで比較対象を広げて同じ計算をしてみたものです。
      多くの学生はMacを利用しており、
      Macのシステムファイルは全員に共通であるため、
      図1に比べると左下部分が赤くなっています。

      <blockquote>
	<img src="https://gyazo.com/5124de74689ff55d53ffb3da92c1c636.png" width=400><br>
	図2: 他人とのファイル共有の視覚化
      </blockquote>

      このように、ハッシュ関数を利用すると
      自分が持っているファイルの素性がなんとなく見えてくるといえるでしょう。
      ファイルの中身をいくら調べてもこういうことはわからないわけですが、
      他のファイルや他人のファイルとの比較により
      ファイルの特徴が見えてくることになります。

      <h2>重要情報のバックアップ</h2>

      前述の方法を使うと、
      複数のマシンでHashInfoを計算することによって、
      様々なマシンで同じファイルが共有されているかどうかがわかります。
      システムファイルやメジャーなアプリケーションのファイルは
      多数のマシンで共有されているはずですが、
      あまり重要でない大きなファイルでも
      いろんなマシンで共有されている可能性があります。

      たとえば<code>Node.js</code>でプログラム開発する場合、
      <code>node_modules</code>というフォルダの下に
      沢山のライブラリがダウンロードされますが、
      このようなファイルはバックアップをする必要はありません。

      <p/>
      ブラウザでWebからデータをダウンロードするとき、
      大きなアプリケーションのプログラムファイルも
      重要なファイルも同じフォルダに入ってしまい、
      広く配られてるファイルと重要なファイルを区別することは困難ですが、
      HashiInfoを利用するとその違いが明白になるので、
      どのファイルが重要なのかがわかるようになります。

      一方、
      コンパイル結果やログファイルなどは
      重要ではないにもかかわらず、
      他人が同じファイルを持っている可能性は低いと思われます。

      「他人と共有していない」「自動生成されるファイルではない」
      といった条件を満たすファイルは重要である可能性が高いので、
      こういう性質をもつファイルだけをバックアップすることにしておけば、
      無駄なバックアップを防ぐことができるでしょう。
      
      <h2>ファイルの存在証明</h2>

      特許や論文になるかもしれない新しいアイデアを思いついたときなど、
      ある時点においてある情報を自分が持っていたことを証明したい場合があります。

      情報がいつ作成されたかを個人的に覚えておくためには
      ファイル作成時刻を記録しておけば良いのですが、
      ファイルの中身や作成時刻は後から偽造できるので、
      確かにその時点でその情報が存在したということを他人に納得させることはできません。
      デジタル情報がいつ作成されたか証明するためには、
      信用できる外部の誰かに認証してもらう必要があります。

      <p/>
      ある時点である書類が存在したことを証明するためには昔から
      「<a href="http://www.koshonin.gr.jp/a2.html">公証役場</a>」
      が利用されています。
      公証役場の業務のひとつに
      「確定日付の付与」
      というものがあります。
      これは、私文書に「確定日付」を付与し、
      その日付にその文書が存在したことを証明するものです。

      <p/>
      デジタルデータを印刷して書類にしておけば、
      その存在を証明するために公証役場を利用することができますが、
      情報を印刷して公証役場に持って行くのは面倒ですし
      費用もかかります。

      最近はデジタル情報の存在を証明するために
      「<a href="http://www.koshonin.gr.jp/de2.html">電子公証システム</a>」
      を利用できるようになったので、
      公証役場に行かなくても
      公的な認証を得られるようになりました。
      これは朗報なのですが、かなりの費用がかかるのが難点です。

      <p/>
      ある時刻にあるデジタルデータが存在したことを証明する技術のことを
      <a href="http://www.imes.boj.or.jp/japanese/kinyu/2000/kk19-b1-4.pdf">デジタルタイムスタンプ</a>技術といいます。
      
      電子公証システム利用は高価であり利便性の問題もあるので、
      <a href="https://www.seiko-cybertime.jp/product/easy_time_stamp/">Seiko</a>や
      <a href="http://www.e-timing.ne.jp/product/timestamp/characteristic/typet/">アマノ</a>
      のような会社が
      デジタルタイムスタンプ技術を提供するサービスを提供しています。

      しかし、大事なデータを民間企業に渡すのは心配ですし、
      サービスがどれほど信頼できるかわかりません。
      実際、現在運営を中止してしまったサービスもありますし、
      10年後/20年後も確実に利用できる保証はありません。

      <p/>
      電子公証システムや民間の証明システムを利用する場合は
      証明したいデータの提示が必要ですが、
      情報が漏れることは心配かもしれません。

      その時点でその情報が存在することは証明したいけれども
      情報の中身は公開したくないかもしれません。

      簡単で良いアイデアを思いついたときなど、
      特許をとるまで内容は誰にも公開したくないでしょうが、
      そのアイデアを自分が思いついた日時については記録しておきたいでしょう。

      つまり
      「情報を持っていることは証明するが、情報そのものは公開しない」
      方法が必要になります。

      <h3>HashInfoによるデジタルタイムスタンプ</h3>

      生のデジタル情報の存在証明を行なうかわりに、
      その情報のハッシュ値の存在証明を行なうことにすれば、
      情報そのものを渡す必要がないのでより安全だと考えられます。

      たとえばある問題の解法を発見したとき、
      たとえば「問題AはBという方法で解決できる」
      といった文字列のハッシュ値を
      公証役場や電子公証サービスに登録しておけば、
      ハッシュ値からもとの文字列を計算することはほぼ不可能なので、
      文字列そのものを登録しなくても証明を行なうことができます。
      
      <p/>
      電子公証サービスや民間のデジタルタイムスタンプサービスを利用しなくても、
      一般的なブックマークサービスやブログサービスを利用することによって
      無料でハッシュ情報の存在を証明できるかもしれません。

      たとえば
      秘密情報のハッシュ値が<code>ABCDEF</code>という値になるとき、
      <code>http://example.com/ABCDEF</code>
      というURLを
      はてブのようなブックマーク登録サイトや
      任意のブログサービスに記録しておけば、
      <code>ABCDEF</code>という情報がどの時点で存在していたかが
      それらのサイトで公開されることになりますから、
      Aという問題を解くための情報が
      ある時点で存在したことが証明されることになります。

      <p/>
      ひとつのサービスだけに登録すると
      そのサイトの管理者に偽造される可能性もあるでしょうが、
      関連のない沢山のサービスに同じ情報を登録しておけば、
      すべてを偽造することは不可能と考えるられるので、
      その情報がその時間に存在したことを
      かなり確実に主張できると思われます。

      <p/>
      つまり、時刻を証明したい情報があるときは必ず
      以下の手順をとることにしておけば、
      確実にデータの存在証明を行なうことができるでしょう。

      <ul>
	<li>情報を秘密の場所に格納する</li>
	<li>情報のハッシュ値を複数のサイトに登録する</li>
      </ul>

      普通のテキストエディタを使っている場合でも、
      気合いを入れてセーブした場合には
      上記の処理を自動的に行なうようにしておけばいいかもしれません。

      秘密にしておくべきもとデータ安全な場所に格納しておけばよいでしょうし、
      暗号化したデータをクラウドなどにもセーブしておけば
      さらに安全かもしれません。

      <h2>HashInfo.net</h2>

      今回は
      HashInfoを利用する3種類のアプリケーションを紹介しましたが、
      多数人間でファイルのハッシュ値を共有するデータベースがあれば
      様々な用途に利用できることが期待できるので、
      誰もがHashInfoを活用できるようにするための
      <code>HashInfo.net</code>
      というサイトを運用したいと考えています。

      <p/>
      一方、こういうサービスではプライバシの問題に気をつける必要があります。
      
      素性が怪しいファイルを他の誰かが持っていることがわかれば
      問題になる可能性もありますし、
      「名寄せ」的に個人が特定される可能性があるので、
      誰がどのハッシュを持っているかという情報は充分に注意して扱う必要があるでしょう。

      しかし、プライバシやセキュリティに充分配慮すれば
      HashInfoが有用な機会は多いはずです。

      <p/>
      Googleは、ファイルの中身よりもファイル間のリンクを重視することで
      検索精度を向上させることに成功しましたが、
      ファイルの中身よりもファイルの重複を重視することによって
      大きな効果を得られる可能性もあるでしょう。

      <code>HashInfo.net</code>の運用などによって
      有益なシステムを構築できればと考えています。
      
    </div>
  </body>
</html>
