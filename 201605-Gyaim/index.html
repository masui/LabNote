<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>コロンブス日和 - Dynamic Macro</title>
    <style type="text/css">
      body {
        background-color:#ffffff;
        font-size:12;
        font-family: "Hiragino Kaku Gothic ProN","メイリオ", "sans-serif";
      }
      a { text-decoration: none; }
      li.bold { font-weight: bold; }
      div.body { width:340pt; }
      div.left { float:left; width:10%; font-weight:bold;}
      div.right { width:50%;}
      h1 { background-color:#4d4; padding:8pt;}
    </style>
  </head>

  <body>
    <div class='body'>
      <h1>コロンブス日和 - Gyaim</h1>
      
      今回は「Gyaim」というMacの日本語入力システムを紹介したいと思います。
      <br/>
      
      この連載は、シンプルなのに便利な
      「コロンブスの卵」的なシステムを紹介する趣旨のものなのに
      日本語入力システムのような複雑なものを取り上げるのは変だと思われるかもしれませんが、
      「Gyaim」は単純な原理にもかかわらず実用的に利用できるIMEなので
      ここで紹介したいと思います。
      
      私はこの連載はすべてGyaimで書いています。
      
      <blockquote>
        <img src="https://gyazo.com/a0447a696b297e56085a20d25372c535.png"><br/>
        AtomでGyaimを使っているところ
      </blockquote>

      
      <h2>かな漢字変換システム</h2>
      
      現在のパソコンでは
      「かな漢字変換システム」で日本語入力を行なうのが普通になっています。
      かな漢字変換システムは
      <!-- 現在湘南工科大学教授の天野真家氏が -->
      1978年に東芝で開発された日本語ワープロで初めて導入されたものですが、
      パソコンの黎明期から標準的に利用されてきています。
      
      かな漢字変換システム以外にも様々な日本語入力システムが提案されてきましたが、
      すごい努力をしなくても普通のユーザがとりあえず使えるうえに
      熟達すれば効率的な入力も可能だという特長があるため、
      将来にわたって
      かな漢字変換方式の日本語入力が廃れることはなさそうです。
      
      <h3>連文節変換</h3>
      
      現在のパソコンのかな漢字変換システムでは
      いわゆる<b>連文節変換</b>が主流になっています。
      連文節変換とは
      文章の読みをすべて入力してから
      漢字混じりの日本語文字列に一気に変換する手法のことで、
      例えば
      「わたしのなまえはなかのです」
      という入力を
      「私の名前は中野です」
      に変換するというものです。
      「私の」「名前は」のように文章を区切った単位を「文節」と呼びますが、
      連文節変換では文節の区切りを意識することなく入力できるのが特長です。

      <p/>
      正しく連文節変換を行なうには日本語の文法や単語の知識を使って
      高度な計算を行なう必要があります。
      
      初期のパソコンでは文節ベースのかな漢字変換システムがよく使われてましたが、
      長い日本語文章を一気に漢字文字列に変換したいという要望が多かったためか、
      現在のパソコンでは連文節変換システムが主流になっています。
      
      <p/>
      連文節変換は一見便利そうですが、実は様々な問題があります。
      
      <ul>
        <li><b>正確な入力が必要</b></li>
        <p/>
        
        ほとんどの日本語入力システムでは、
        入力文字が1文字でも間違っていれば変換することができません。
        「ふいんき」を「雰囲気」に変換してくれるようなシステムもありますが、
        「雰囲気」を「ふいんき」という読みでも登録しているだけであり、
        「ふんにき」を「雰囲気」に変換することはできません。
        
        <li><b>完全な読みの入力が必要</b></li>
        <p/>
        
        連文節変換システムでは長い単語もすべて正確に入力する必要があります。
        例えば「品川駅にいます」と入力したい場合は
        正確に「しながわえきにいます」と入力する必要があります。
        文節単位の予測入力システムであれば
        「しな」と入力したところで「品川駅」が候補に出る可能性があり
        完全な読みを入力する必要がありませんが、
        予測を利用しない連文節変換システムでは完全な読みを入力する必要があります。
        
        <li><b>変換誤りの訂正が必須</b></li>
        <p/>
        
        「わたしのなまえ」は
        普通は「私の名前」に変換すれば良いでしょうが、
        ユーザが「綿氏の生絵」と入力したかったという可能性もゼロではありません。
        「きょうはいしゃにいった」は
        「今日は医者に行った」なのか
        「今日歯医者に行った」のどちらに変換すべきなのか
        計算機が判断することは不可能です。
        かな漢字変換システムの性能をいくら向上させても
        ユーザが訂正する必要は残ってしまいます。
        
        <li><b>非力なマシンで使いにくい</b></li>
        <p/>
        
        正確な変換を行なうためには充分な計算パワーが必要であり、
        小型の計算機では充分な速度で正確な連文節変換を行なうことができないでしょう。

      </ul>
      
      これからのユビキタス社会社会においては、
      パソコン環境で熟練者にとってのみ使える入力手法ではなく、
      どこでも誰でも簡単に使えるシンプルで柔軟で効率良い入力方式が必要でしょう。

      <ul>
        <li>キーやボタンなどの数が少ない</li>
        <li>操作の種類が少ない</li>
        <li>入力に必要な操作量が少ない</li>
        <li>ユーザがカスタマイズ可能</li>
        <li>様々な環境で同じ方式が使える</li>
      </ul>
      
      このような要件を満たすためには、
      単純なアルゴリズムにもとづいて
      単純な操作で入力を行なえるような
      システムが良いと考えられます。
      
      <h3>SKK</h3>
      
      連文節変換を行なわないのであれば、
      基本的にかな漢字変換というのは
      読みを漢字に変換する単純な検索作業に近く、
      動詞の活用などに対応できれば
      日本語入力は簡単に実装できてしまいます。
      
      <p/>
      単純な仕組みで日本語入力を行なうシステムの例として、
      Emacs上の
      <a aref="http://openlab.ring.gr.jp/skk/doc-ja.html">SKK</a>
      というシステムがあります。

      SKKは
      1987年ごろ
      現在京都大学名誉教授の佐藤雅彦氏が東北大学にいたとき開発した
      Emacs用の日本語入力システムです。

      <p/>
      SKKには英数字モードと日本語モードがあり、
      日本語モードでローマ字を入力するとひらがなが入力されますが、
      「書く」のような文字を入力したい場合は
      「KaKu」のように大文字と小文字を混ぜたローマ字を入力します。
      最初の大文字「K」は変換開始を意味しており、
      ふたつめの大文字「K」は送り仮名の開始を意味しています。
      SKKの変換辞書には以下のようなエントリが含まれており、
      この情報と「KaKu」というユーザ入力を利用して
      「書く」や「欠く」のような文字列を生成するようになっています。
      
      <pre>
      かk /書/掛/欠/
      </pre>
      
      <blockquote>
        <img src="https://gyazo.com/ab986b8d454f756869eaff399d4e0ec1.png">
      </blockquote>
      
      <h3>Gyaim</h3>
      
      SKKは単純な仕組みで効率的な日本語入力ができるコロンブスの卵的なシステムであり、
      とても優れた日本語入力システムなのですが、
      一般的なかな漢字変換システムと同じように
      すべての読みを正確に入力しなければならないうえに、
      漢字や送り仮名についてユーザが明示的に指定しなければならないためユーザの負担が大きく、
      万人向けとは言い難いものでした。
      
      私は1990年代ごろはSKKを愛用していたのですが、
      予測入力システムPOBoxの開発後は
      あらゆる場所でこれに準じた入力手法を使っており、
      MacではGyaimというシステムを作って使っています。
      
      <p/>
      GyaimはMac上で動くシンプルで汎用的な日本語入力システムです。
      Gyaimは1000行ほどのRubyで記述されており、
      現在スマホなどでポピュラーになっている
      予測入力と同じように利用することができます。

      Macのアプリケーションは通常は
      Objective-CかSwiftで記述するのが普通ですが、
      ...ごろから
      MacOSのCocoaライブラリを利用できるようにRubyに拡張を加えた
      MacRubyというシステムを使って
      アプリケーション、IME、スクリーンセーバなどを
      Rubyで記述することができるようになっていました。

      MacRubyは無料のシステムだったのですが、
      残念ながら開発が終了してしまい、
      Yosemite以降で使えなってしまいました。
      ところが幸いなことにRubyMotionという別の商用システムが利用できるようになったため、
      YosemiteやEl Capitanでは
      RubyMotionを使ってアプリケーションやIMEを作ることができるようになっており、
      現在最新版のGyaimはRubyMotionを使って実装しています。
      残念ながらRubyMotionはMacRubyと異なりスクリーンセーバ等を作ることはできないようです。

      <h4>MacのIMEの実装</h4>

      Unixの実行ファイルのフォーマットはひとつしかありませんが、
      Macの実行プログラムには様々な型式があり、
      通常アプリケーション/スクリーンセーバ/IMEなどの種類により
      異なる型式のBundleを用意しなければなりません。

      たとえばMacのアプリケーションTextEdit.appは
      ...
      のような構造をしています。
      Unixの実行ファイルは
      ....
      ですが、
      インタフェースビルダのファイルや
      いろんなものがまとまって
      TextEdit.appというひとつのディレクトリに格納されています。

      RubyMotionでアプリケーションを作る場合、
      Rubyの実行環境とRubyスクリプトをまとめたものが
      

      IMEを作る場合、
      
      <ul>
	      <li>普通のアプリケーション(e.g. Gyaim.app)を作成する</li>
	      <li>Info.plistをIME用に修正する</li>
	      <li>Gyaim.appを~/Library/Input Methodsに置く</li>
      </ul>
      この後、
      環境設定画面でIMEを選択します。

      IMEではアイコンがあると便利なので、
      またその他の設定も必要だったりするので
      それらをInfo.plistで指定します。

      <h3>Gyaimの実装</h3>
      
      IMEは大まかにいって
      仮名漢字変換アルゴリズムと
      インタフェース
      を用意する必要があります。
      変換アルゴリズムはあらゆるマシンで共通のものを利用できますが、
      インタフェースはマシンごとに用意する必要があります。
      
      
      <h4>IMEインタフェース</h4>
      
      MacにはIMKitというIME作成用ライブラリが用意されており、
      それを利用してIMEを作成することができます。

      Gyaimでは ...handle... というAPIのみを利用しています。

      <h4>かな漢字変換アルゴリズム</h4>

      GyaimではSKKと同様に
      読みと漢字の対応辞書を使ってかな漢字変換を行ないます。

      たとえば日本語入力モードで「とうきょう」と入力されたとき、
      辞書から「とうきょう」という読みをもつ単語を検索してリストして候補として表示し、
      ユーザの操作で候補を選択してテキストに貼り付けます。

      「東京」の後には「駅」や「大学」のような単語が続くことがあります。
      「東京駅」「東京大学」のような単語をすべて辞書に登録しておくのは大変なので、
      「東京は地名である」「地名の後には駅や大学が続くことがある」
      という情報を辞書に登録しておくことにより、
      「東京駅」が辞書に登録されてなくても「とうきょうえき」を「東京駅」に変換できるようにしています。

      同じ手法で動詞の変化形も扱うことができます。
      たとえば辞書に
      「歩」の読みは「ある」である
      「歩」の後にはカ行五段活用語尾がつながる
      「か」はカ行五大活用語尾である
      ...
      のように定義しておけば
      「あるかない」を「歩かない」に変換できます。

      このように、単語の読みと属性、接続情報を定義しておくだけで
      それなりに自然言語を入力することができますし、
      日本語以外の文字入力でも利用できるのが特徴です。
      
      <p/>
      前の単語からの予測機能は実装していませんが、
      簡単に実装することができるでしょう。
      
      <h3>Gyaimの特殊機能</h3>
      
      <h4>単語登録機能</h4>
      
      一般的なIMEは単語登録が面倒なことが多いので、
      頻繁に単語登録を行なっている人は多くないと思います。
      大抵のIMEにおいて、単語登録は入力とは全く異なるインタフェースになっていますが、
      Gyaimでは入力操作と登録操作をほとんど同じにすることにより
      簡単に単語登録が行なえるようになっています。
      Gyaimでは
      「選択中の文字列があったりコピーバッファに文字列がった場合は候補として表示する」
      という単純な方法で単語登録を可能にしています。
      たとえば「＼(^o^)／」という文字列を「owata」という読みで登録したい場合は
      まず「＼(^o^)／」という文字列を選択またはコピーしておいてから
      Gyaimで「owata」と入力すると「＼(^o^)／」が候補の先頭に表示され、
      これを選択して確定することにより単語登録が終了します。
      
      <blockquote>
        <img src="https://gyazo.com/e2f8a3ed51c7c26c6a29d0e5bc72bedf.png">
      </blockquote>
      
      <blockquote>
        <img src="https://gyazo.com/c270c0348d79b0f8073160fa7f546f08.png">
      </blockquote>
        
      <blockquote>
        <img src="https://gyazo.com/1acb7fef6bade88eb0012299a7fe9669.png">
      </blockquote>
        
      <h4>画像変換</h4>
      
      Gyaimでは
      辞書の中で文字列のかわりにGyazoの画像ファイル名を登録しておくと
      漢字のかわりに画像を入力することができます。<
      たとえば私の顔画像を「masui」という読みで登録しておくと、
      Gyaimで「masui」と入力することにより
      顔画像を入力することができます。
      
      <blockquote>
        <img src="https://gyazo.com/b5bb4129996ebf1d543ed9cf98c3bac9.png">
      </blockquote>
      
      <blockquote>
        <img src="https://gyazo.com/556870837a397d998a8a48c0b255876f.png">
      </blockquote>
      
      <h4>時刻の入力</h4>
      
      Gyaimでは「ds」と入力すると現在時刻が候補に出るようになっているので
      文章やプログラムの中に手軽にタイムスタンプを記録しておくことができます。
      数式演算機能その他、
      欲しい機能を追加することも
      簡単です。
      こういったちょっとした機能が用意されているIMEはありますが、
      GyaimはRubyを少し書くだけで特殊な機能でも簡単に追加できるのが嬉しいところです。
      
      <h4>秘密文字列の入力</h4>
      
      ブラウザなどでパスワードやクレジットカード番号を入力するのは面倒なものですが、
      IMEでこれらを覚えておけば簡単に入力を行なうことができます。
      もちろんこれらを生テキストで単語登録するのは危険ですが、
      秘密の文字列を変換することによりクレジットカード番号が候補に表示されて
      入力可能にしています。
      
      <h4>Google変換の利用</h4>
      
      Gyaimの辞書は貧弱なのでうまく変換できないこともよくありますが、
      そういうときは
      Google Translateのような
      Web上の変換APIを利用して変換を行なえるようにしています。
      
      <p/>
      <hr/>
      <p/>
      
      自分が使っているIMEが気に入らなくて困っている人は多いと思いますが、
      自分でIMEを作ってしまおうと考える人は多くないのが現状かもしれません。
      しかし最近はIMKitのようなライブラリがあるので
      パソコンやスマホのIMEを作ることは比較的簡単になりました。
      
      私のように簡単な変換を好む人はGyaimのような方法を工夫すれば良いでしょうし、
      連文節変換が好きな人は
      Googleなどの変換APIを利用することもできます。
      IMEの作成が大変だった昔と異なり、現在は
      IME用のAPI /
      使い易い強力な言語 /
      Webの変換API /
      高度な入出力機能 /
      などを利用できますから
      IME作成のハードルは極めて低くなってるといえるでしょう。
      
      GyaimのようなIMEを作る試みがもっと増えてくると良いと思っています。
      


<!--
      実際、Google日本語入力のように、
      
新しいアルゴリズムを使った連文節仮名漢字変換システムの開発が続いています。
Google日本語入力システムでは、大規模な文例データ(\idxyomi{コーパス}{こーぱす})に基づいた
\idxyomi{自然言語処理}{しぜんげんごしょり}技術や高度な\idxyomi{圧縮技術}{あっしゅくぎじゅつ}を駆使して
効率の良い入力が可能になっています。
      
      
      Gyaim\url{
  https://github.com/masui/Gyaim
}はMac上で動作するシンプルな予測型日本語入力システムです。
Macでは、標準装備の「\system{ことえり}」や
市販の「\system{ATOK}」のような連文節変換システムが広く使われていますが、
Gyaimは連文節変換を行なわず、
文字を\rensuji{1}文字入力するたびに変換候補を辞書から検索してリストするという方法をとっており、
必要な単語が出たところで入力をやめて候補を選ぶことができるようになっています。
たとえば「\textsf{shinag}」と入力した段階で「品川」を選んで入力することができます。

Gyaimは\idx{MacRuby}というスクリプト言語で実装されています。
MacRubyは汎用スクリプト言語\idx{Ruby}\footnote{
  Rubyは\idx{まつもとゆきひろ}氏が開発したプログラミング言語で、
  現在世界中で広く利用されています。
}をMac用に拡張したシステムで、
Rubyのすべての機能を利用できることに加え、
全てのMacのライブラリを利用することができます。
Macのアプリケーション開発は\idx{Objective-C}を利用するのが普通ですが、
Rubyは文字列処理を簡単に行なうことができるので、
Gyaimはわずか数百行で実装されています。
-->

      
    </div>
  </body>
</html>

