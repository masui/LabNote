<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>コロンブス日和 - Dynamic Macro</title>
    <style type="text/css">
      body {
        background-color:#ffffff;
        font-size:12;
        font-family: "Hiragino Kaku Gothic ProN","メイリオ", "sans-serif";
      }
      a { text-decoration: none; }
      li.bold { font-weight: bold; }
      div.body { width:340pt; }
      div.left { float:left; width:10%; font-weight:bold;}
      div.right { width:50%;}
      h1 { background-color:#4d4; padding:8pt;}
    </style>
  </head>

  <body>
    <div class='body'>
      <h1>コロンブス日和 - Gyaim</h1>
      
      今回は「<a href="http://masui.github.io/GyaimMotion/">Gyaim</a>」というMacの日本語入力システムを紹介します。
      <p/>
      
      この連載は、シンプルなのに便利な
      「コロンブスの卵」的なシステムを紹介する趣旨のものなのに
      日本語入力システムのような複雑なものを取り上げるのは変だと思われるかもしれませんが、
      「Gyaim」は単純な原理にもかかわらず実用的に利用できるIMEなので
      ここで紹介したいと思います。
      
      私はこの連載はすべてGyaimで書いています。
      
      <blockquote>
        <img src="https://gyazo.com/a0447a696b297e56085a20d25372c535.png"><br/>
        AtomでGyaimを使っているところ
      </blockquote>

      
      <h2>かな漢字変換システム</h2>
      
      現在のパソコンでは
      「かな漢字変換システム」で日本語入力を行なうのが普通になっています。
      かな漢字変換システムは
      <!-- 現在湘南工科大学教授の天野真家氏が -->
      1978年に東芝で開発された日本語ワープロで初めて導入されたものですが、
      パソコンの黎明期から標準的に利用されてきています。
      
      かな漢字変換システム以外にも様々な日本語入力システムが提案されてきましたが、
      それほど努力しなくても普通のユーザがとりあえず使えるうえに、
      熟達すれば高速に入力が可能だという特長があるため、
      かな漢字変換方式の日本語入力が廃れることはなさそうです。
      
      <h3>連文節変換</h3>
      
      現在のパソコンのかな漢字変換システムでは
      いわゆる<b>連文節変換</b>が主流になっています。
      連文節変換とは
      文章の読みをすべて入力してから
      漢字混じりの日本語文字列に一気に変換する手法のことで、
      例えば
      「わたしのなまえはなかのです」
      という入力を
      「私の名前は中野です」
      に変換するというものです。
      「私の」
      「名前は」
      のように
      文章を息継ぎできる場所で区切った単位を「文節」と呼びますが、
      連文節変換では文節の区切りを意識することなく入力できるのが特長です。

      <p/>
      正しく連文節変換を行なうには日本語の文法や単語の知識を使って
      高度な計算を行なう必要があります。
      
      初期のパソコンでは文節ベースのかな漢字変換システムがよく使われてましたが、
      長い日本語文章を一気に変換したいという要望が多かったためか、
      現在のパソコンでは連文節変換システムが主流になっています。
      
      <p/>
      連文節変換は一見便利そうですが、実は様々な問題があります。
      
      <ul>
        <li><b>正確な入力が必要</b></li>
        <p/>
        
        ほとんどの日本語入力システムでは、
        入力文字が1文字でも間違っていれば正しく変換することができません。
        「ふいんき」を「雰囲気」に変換してくれるようなシステムもありますが、
        「雰囲気」を「ふいんき」という読みでも登録しているだけであり、
        「ふんにき」を「雰囲気」に変換することはできません。
        
        <li><b>完全な読みの入力が必要</b></li>
        <p/>
        
        連文節変換システムでは長い単語もすべて正確に入力する必要があります。
        例えば「品川駅にいます」と入力したい場合は
        正確に「しながわえきにいます」と入力する必要があります。
        文節単位の予測入力システムであれば
        「しな」と入力したところで「品川駅」が候補に出る可能性があり
        完全な読みを入力する必要がありませんが、
        予測を利用しない連文節変換システムでは
        文章の完全な読みを正確に入力する必要があります。
        
        <li><b>変換誤りの訂正が必須</b></li>
        <p/>
        
        「わたしのなまえ」は
        普通は「私の名前」に変換すれば良いでしょうが、
        ユーザが「綿氏の生絵」と入力したかったという可能性も皆無ではありません。
        「きょうはいしゃにいった」は
        「今日は医者に行った」なのか
        「今日歯医者に行った」のどちらに変換すべきなのか
        計算機が判断することは不可能です。
        かな漢字変換システムの性能をいくら向上させても
        ユーザが訂正する必要は必ず存在し、
        そのためのインタフェースが必要になります。
        
        <li><b>非力なマシンで使うのが辛い</b></li>
        <p/>
        
        正確な変換を行なうためには充分な計算パワーが必要であり、
        小型の計算機では快適に連文節変換を行なうことができないでしょう。

      </ul>
      
      これからのユビキタス社会においては、
      パソコンの熟練者だけが使える入力手法ではなく、
      どこでも誰でも簡単に使えるシンプルで柔軟な入力方式が必要であり、
      以下の要件が満たされる必要があるでしょう。

      <ul>
        <li>キーやボタンなどの数が少ない</li>
        <li>操作の種類が少ない</li>
        <li>入力に必要な操作量が少ない</li>
        <li>ユーザがカスタマイズ可能</li>
        <li>様々な環境で同じ方式が使える</li>
      </ul>
      
      このような要件を満たすためには、
      単純なアルゴリズムにもとづいて
      単純な操作で入力を行なえるような
      コロンブスの卵的なシステムが必要だと思われます。
      
      <h3>SKK</h3>
      
      連文節変換を利用しいない場合、
      かな漢字変換というのは
      辞書を参照して読みを漢字に変換する単純な検索作業に近く、
      動詞の活用などに対応できれば
      それほど難しいものではありません。
      
      <p/>
      単純な仕組みで日本語入力を行なうシステムの例として、
      Emacs上の
      <a aref="http://openlab.ring.gr.jp/skk/doc-ja.html">SKK</a>
      というシステムがあります。

      SKKは
      1987年ごろ
      現在京都大学名誉教授の佐藤雅彦氏が東北大学にいたとき開発した
      Emacs用の日本語入力システムです。

      <p/>
      SKKには英数字モードと日本語モードがあります。
      日本語モードでローマ字を入力するとひらがなが入力されますが、
      「書く」のような漢字を含む動詞を入力したい場合は
      「KaKu」のように大文字と小文字を混ぜたローマ字を入力します。
      最初の大文字「K」は漢字入力の開始を意味しており、
      ふたつめの大文字「K」は送り仮名の開始を意味しています。
      SKKの変換辞書には以下のようなエントリが含まれており、
      この情報と「KaKu」というユーザ入力を利用して
      「書く」や「欠く」のような文字列を生成するようになっています。
      
      <pre>
      かk /書/掛/欠/
      </pre>
      
      Emacs上では以下のように変換が行なわれます。
      
      <blockquote>
        <img src="https://gyazo.com/ab986b8d454f756869eaff399d4e0ec1.png">
      </blockquote>
      
      <h3>Gyaim</h3>
      
      SKKは単純な仕組みで効率的な日本語入力ができるコロンブスの卵的なシステムであり、
      とても優れた日本語入力システムなのですが、
      一般的なかな漢字変換システムと同じように
      すべての読みを正確に入力しなければならないうえに、
      漢字や送り仮名についてユーザが明示的に指定しなければならないためユーザの負担が大きく、
      万人向けとは言い難いものでした。
      
      私は1990年代ごろはSKKを愛用していたのですが、
      予測入力システムPOBoxの開発後は
      あらゆる場所でこれに準じた入力手法を使っており、
      MacではGyaimというシステムを作って使っています。
      
      <p/>
      GyaimはMac上で動くシンプルで汎用的な日本語入力システムです。
      Gyaimは1000行ほどのRubyで記述されており、
      スマホなどでポピュラーになった
      予測入力システムと同じように利用することができます。

      <p/>
      Macのアプリケーションは
      Objective-CやSwiftで開発するのが普通ですが、
      MacOSのCocoaライブラリを利用できるようにRubyに拡張を加えた
      RubyCocoaやMacRubyといったシステムを使うことによって
      RubyでMacのアプリケーションを開発することができました。

      これらは無料のシステムだったのですが、
      残念ながら開発が終了してしまって
      Yosemite以降では使えなくなってしまいました。
      幸い、これらの後継といえるRubyMotionという商用システムを利用すれば
      YosemiteやEl Capitan上で
      アプリケーションやIMEを作ることができるようになっているので、
      現在のGyaimはRubyMotionを使って実装しています。

      <p/>
      Macの実行プログラムには様々な型式があり、
      普通のアプリケーション / スクリーンセーバ / IMEなど
      実行するプロセスの種類により
      異なる型式で実行プログラムと関連ファイルを用意して
      ひとつのフォルダにまとめる必要があります。

      たとえばMacのアプリケーションTextEdit.appは
      <code>/Applications/TextEdit.app/Contents/MacOS/TextEdit</code>
      という実行ファイル、
      <code>/Applications/TextEdit.app//Contents/Resources/</code>
      の下の各種リソース、
      <code>/Applications/TextEdit.app/Contents/Info.plist</code>
      という設定ファイルなどをまとめた
      ディレクトリとして構成されています。

      Gyaimの場合、
      <code>Gyaim.app/Contents/MacOS/Gyaim</code>
      という実行ファイル、
      <code>Gyaim.app/Contents/Info.plist</code>
      という設定ファイル
      などをまとめた
      Gyaim.appというディレクトリを作ることになります。
      
      <!--
      GyaimMotionは通常のアプリを作る機能しか持っていないので、
      IME用のInfo.plistは自分で用意する必要があります。
    -->
    
      <p/>
      Gyaimは以下の手順で作成/インストールします。
      
      <ul>
	      <li>RubyMotionでGyaim.appアプリケーションを作成する</li>
	      <li>Info.plistをIME用に修正する</li>
	      <li>Gyaim.appを<code>~/Library/Input Methods</code>に置く</li>
      </ul>
      
      このように設定を行なった後、
      環境設定画面の「キーボード」→「入力ソース」でIMEにGyaimを選択します。
      
      <h3>Gyaimの実装</h3>
      
      IMEを作成するためには
      (1)かな漢字変換アルゴリズム
      と
      (2)ユーザインタフェース
      が必要になります。
      変換アルゴリズムは
      AndroidでもMacでも同じものを利用できますが、
      インタフェースはマシンごとに用意する必要があります。
      
      <h4>IMEのユーザインタフェース</h4>
      
      Macには
      <a href="https://developer.apple.com/library/mac/documentation/Cocoa/Reference/InputMethodKitFrameworkRef/">IMKit</a>
      というIME作成用ライブラリが用意されており、
      それを利用してIMEを作成することができます。

      IMKitには様々な機能が用意されていますが、
      Gyaimでは
      <code>IMKInputController</code>
      クラスの
      <code>handleEvent</code>
      というAPIのみを利用しています。

      <h4>かな漢字変換アルゴリズム</h4>

      GyaimではSKKと同様に
      読みと漢字の対応辞書を使ってかな漢字変換を行ないます。

      たとえば日本語入力モードで「とうきょう」と入力されたとき、
      辞書から「とうきょう」という読みをもつ単語を検索してリストして候補として表示し、
      ユーザの操作で候補を選択してテキストに貼り付けます。

      <p/>
      「東京」の後には「駅」や「大学」のような単語が続くことがあります。
      「東京駅」「東京大学」のような単語をすべて辞書に登録しておくのは大変なので、
      「東京は地名である」「地名の後には駅や大学が続くことがある」
      という情報を辞書に登録しておくことにより、
      「東京駅」が辞書に登録されてなくても「とうきょうえき」を「東京駅」に変換できるようにしています。

      同じ手法で動詞の変化形も扱うことができます。
      たとえば辞書に
      
      <ul>
        <li>「書」の読みは「か」である</li>
        <li>「書」の後にはカ行五段活用語尾がつながる</li>
        <li>「か」はカ行五段活用語尾である</li>
      </ul>
      
      といった情報を定義しておけば
      「かかない」を「書かない」に変換できます。

      このように、単語の読みと属性、接続情報を定義しておくだけで
      それなりに自然言語を入力することができますし、
      日本語以外の文字入力でも利用できるのが特徴です。
      
      <h3>Gyaimの特殊機能</h3>
      
      Gyaimでは前述のような非常に単純な変換手法を使っていますが、
      特殊な機能も用意しています。
      自前のIMEだと好きな機能を自由に実装できるのが面白いところです。
      
      <h4>単語登録機能</h4>
      
      一般的なIMEは単語登録が面倒なことが多いので、
      頻繁に単語登録を行なっている人は多くないと思われます。
      大抵のIMEにおいて、単語登録は入力とは全く異なるインタフェースになっていますが、
      Gyaimでは入力操作と登録操作をほとんど同じにすることにより
      簡単に単語登録が行なえるようになっています。
      Gyaimでは
      「選択中の文字列があったりコピーバッファに文字列があった場合は候補として表示する」
      という単純な方法で単語登録を可能にしています。
      
      <p/>
      たとえば「＼(^o^)／」という文字列を「owata」という読みで登録したい場合、
      「＼(^o^)／」という文字列を選択またはコピーしておいてから
      Gyaimで「owata」と入力すると「＼(^o^)／」が候補の先頭に表示され、
      これを選択して確定することにより単語登録が終了します。
      
      <blockquote>
        <img src="https://gyazo.com/e2f8a3ed51c7c26c6a29d0e5bc72bedf.png"><br/>
        「＼(^o^)／」が登録されていない状態
      </blockquote>
      
      <blockquote>
        <img src="https://gyazo.com/c270c0348d79b0f8073160fa7f546f08.png"><br/>
        「＼(^o^)／」がコピーバッファに入ってる状態で「owa」と入力したとき
      </blockquote>
        
      <blockquote>
        <img src="https://gyazo.com/1acb7fef6bade88eb0012299a7fe9669.png"><br/>
        「＼(^o^)／」を選択したところ。確定すると単語登録される。
      </blockquote>
        
      <h4>画像変換</h4>
      
      Gyaimでは
      辞書の中で文字列のかわりにGyazoの画像ファイル名を登録しておくと
      漢字のかわりに画像を入力することができます。<
      たとえば私の顔画像を「masui」という読みで登録しておくと、
      Gyaimで「masui」と入力することにより
      顔画像を入力することができます。
      
      <blockquote>
        <img src="https://gyazo.com/b5bb4129996ebf1d543ed9cf98c3bac9.png">
      </blockquote>
      
      <blockquote>
        <img src="https://gyazo.com/556870837a397d998a8a48c0b255876f.png">
      </blockquote>
      
      <h4>時刻の入力</h4>
      
      Gyaimでは「ds」と入力すると現在時刻が候補に出るようになっているので
      文章やプログラムの中に手軽にタイムスタンプを記録しておくことができます。
      数式演算機能その他、
      欲しい機能を追加することも
      簡単です。
      こういったちょっとした機能が用意されているIMEはありますが、
      GyaimはRubyを少し書くだけで特殊な機能でも簡単に追加できるのが嬉しいところです。
      
      <h4>秘密文字列の入力</h4>
      
      ブラウザなどでパスワードやクレジットカード番号を入力するのは面倒なものですが、
      IMEでこれらを覚えておけば簡単に入力を行なうことができます。
      もちろんこれらを生テキストで単語登録するのは危険ですが、
      秘密の文字列を変換することによりクレジットカード番号が候補に表示されて
      入力可能にしています。
      
      <h4>Google変換の利用</h4>
      
      Gyaimの辞書は貧弱なのでうまく変換できないこともよくありますが、
      そういうときは
      Google Translateのような
      Web上の変換APIを利用して変換を行なえるようにしています。
      
      <p/>
      <hr/>
      <p/>
      
      IMEは複雑な要素を含んでいるので
      Gyaimの詳細について書くことはできませんでしたが、
      とりあえず簡単なIMEをMacで作ることができることが理解いただけたでしょうか。
      
      <br/>
      使っているIMEが気に入らなくて困っている人は多いと思いますが、
      自分でIMEを作ってしまおうと考える人は多くないのが現状かもしれません。
      しかし最近はIMKitのようなライブラリや
      RubyMotionのような開発環境があるので
      パソコンやスマホのIMEを作ることは比較的簡単になりました。
      
      <br/>
      私のように単純な変換方式を好む人はGyaimのような方法を工夫すれば良いでしょうし、
      連文節変換が好きな人は
      Googleなどの変換APIを利用することもできます。
      IMEの作成が大変だった昔と異なり、現在は
      IME用のAPI /
      使い易い強力な言語 /
      Webの変換API /
      高度な入出力機能 /
      などを利用できますから
      IME作成のハードルは極めて低くなってるといえるでしょう。
      
      IMEを自分で作る試みがもっと増えてくると良いと思っています。
      
      <p/>
      Gyaimのソースコードは
      https://github.com/masui/GyaimMotion
      で公開しています。
      
    </div>
  </body>
</html>

