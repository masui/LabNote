<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>コロンブス日和 - Dynamic Macro</title>
    <style type="text/css">
      body { background-color: #ffffff; font-size:12; font-family: "Hiragino Kaku Gothic ProN","メイリオ", sans-serif;}
      a { text-decoration: none; }
      li.bold { font-weight: bold; }
      div.body { width:340pt; }
      div.left { float:left; width:10%; font-weight:bold;}
      div.right { width:50%;}
      h1 { background-color:#ddf; padding:8pt;}
    </style>
  </head>

  <body>
    <div class='body'>

      <h1>コロンブス日和 - Dynamic Macro</h1>

      コンピュータ上で
      同じ作業を何度も繰り返さなければならないことがよくあります。
      計算機は単純な繰り返し作業が得意なはずですが、
      つまらない作業を人間が繰り返さなければならないことは意外と多いものです。
      
      たとえばExcelの表の中の負の数字だけアンダーラインをつけたいときはどうすれば良いでしょうか?
      そういう機能はExeclには用意されてるかもしれませんが、
      知らなければ使えませんし、
      同じような処理であってもシステムに用意されていなければどうしようもありませんから、
      この手の仕事があったときは
      泣きながら手作業で処理している人が多いのではないでしょうか。
      
      <p/>
      コンピュータ上の操作を効率化するために
      「<b>予測インタフェース</b>」と呼ばれるシステムが広く使われています。
      スマホのテキスト入力を効率化する「予測入力システム」や
      ブラウザのURL補完機能、エディタの補完機能は予測インタフェースの一種です。
      これまでの購入履歴をもとにして商品を推薦するシステムなども
      一種の予測インタフェースといえるでしょう。
      
      <p/>
      これらのシステムでは、
      アプリケーションに関連したデータベースやユーザの操作履歴をもとにして
      ユーザの次の操作を予測することによって
      ユーザの仕事を減らす工夫をしています。
      
      URL補完の場合はよく使われるURLのデータベースが利用できますし、
      プログラミング言語に関する情報を持っていれば
      ユーザが次に入力する言語キーワードを予測できるかもしれません。
      
      このような固定的なデータベースを用意しておくことも重要ですが、
      ユーザの操作履歴を予測のためのデータベースとして利用すると便利です。
      
      ユーザが一度訪れたサイトのURLは補完に利用できますし、
      予測入力システムではユーザが選択したことがある単語やフレーズが次の予測に利用されます。
      
      前述のExcelの例のような場合、
      負の数字にアンダーラインをつける操作が繰り返されていることを検出できれば
      ユーザの次の操作を予測することができるでしょう。
      
      <h2>編集作業の効率化</h2>
      
      文章やプログラムのようなテキストを編集するとき、
      同じような操作を繰り返すことがよくあります。
      
      例えば、連続する行の先頭に記号を挿入したいような場合、
      カーソルを1行ずつ動かして記号を入れるのが普通ですが、
      沢山の行に対して同じ操作を繰り返すのは面倒です。
      行頭に記号を挿入するプログラムを書けば良いのかもしれませんが、
      一度きりかもしれない処理のためにプログラムを作成するのは面倒ですし、
      プログラミングができない人はそういうことができません。

      また、csvデータのデータ一位置を入れ替えたいときはどうでしょうか?
      csvデータを読み取ってから並びを変えて出力すれようなプログラムを使えば良いかもしれませんが、
      わざわざそれだけのためにプログラムを書くのは面倒でしょう。

      <p/>
      このような場合のために「キーボードマクロ」という機能が用意されているエディタがあります。
      キーボードマクロとは、一連のエディタ操作をひとつのキー操作に割り当てることにより、
      複雑な編集操作を楽に実行しようというものです。
      
      例えば「行頭に記号を挿入してからひとつ下の行に移動する」という処理を
      Aというキーに割り当てておけば、
      Aを連打することによって連続する行の先頭に記号を入力していくことができますし、
      「カンマで区切られた部分を選択して移動してから次の行に移動する」という処理を
      Bというキーに割り当てておけば、
      Bを連打することによってcsvの桁を入れ替えていくことができます。
      
      <p/>
      キーボードマクロは便利な機能ですが、
      「キーボードマクロの定義を開始する」「キーボードマクロの定義を終了する」
      という二つの操作が必要であるうえに、
      正確にキー操作を登録するのが難しいという問題があります。
      たとえば前述の例の場合、「ひとつ下の行に移動する」処理を定義に含めることを忘れてしまうと
      正しく動きません。
      
      <h2>Dynamic Macro</h2>
      
      キーボードマクロの機能をもっと簡単に使えるようにするため、
      私は
      キーボードの繰り返し操作から次の操作を予測して自動的にキーボードマクロとして登録することができる
      Dynamic Macro
      というシステムを作って長年利用しています。
      
      <p/>
      Dynamic Macroの原理は非常に単純で、
      
      <blockquote>
      「同じ編集操作を2回繰り返した後で「繰り返しキー」を押すと繰り返された操作が再実行される」
      </blockquote>
      
      というものです。
      
      Dynamic Macroは
      予測インタフェースの考え方を
      キーボードマクロに応用したものだといえます。
      
      ユーザの繰り返し操作をもとにして次の操作を「予測」し、
      それをキーボードマクロのように利用できるからです。
      
      予測と言っても
      繰り返し操作からの「予測」なので
      誤った予測をしてしまう可能性はほとんどありません。
      
      <p/>
      キーボードマクロと比較すると以下のような利点があります。
      
      <ul>
        <li>使うキーがひとつだけ</li>
        <li>定義の開始と終了を指定する必要がない</li>
        <li>操作を行なった後で繰り返し実行を指示できる</li>
      </ul>
      
      <h3>EmacsのDynamic Macro</h3>
      
      Emacs上に実装したDynamic Macroの利用例を示します。
      
      以下の図はEmacsで<code>abcabc</code>と入力したところです。
      
      <blockquote>
        <img src="https://gyazo.com/18625ae67a38b3092141ddefaf07d279.png" width=300>
      </blockquote>
      
      ここで
      <img src="https://gyazo.com/371a8ef3f8750394c0eaffa908424810.png" height=22 style="vertical-align:middle;">
     
      を押すと、
      Emacsのキー操作履歴から
      <code>abc</code>入力の繰り返しが検出され、
      キーボードマクロとして登録されて実行され、
      以下のようにもうひとつ<code>abc</code>が挿入されます。
      
      <blockquote>
        <img src="https://gyazo.com/7e6818299af63bada73a03ca49a8fd12.png" width=300>
      </blockquote>
      
      再度
      <img src="https://gyazo.com/371a8ef3f8750394c0eaffa908424810.png" height=22 style="vertical-align:middle;">
      を押すと、
      以下のようにまた<code>abc</code>が入力されます。
      
      <blockquote>
        <img src="https://gyazo.com/dfbb2878d8cc5af1e57a9076c2415c36.png" width=300>
      </blockquote>
      
      これは単純な例でしたが、Dynamic Macroはもっと複雑な編集操作でも使うことができます。
      
      <blockquote>
        <img src="https://gyazo.com/5b6db6ef31dd1300c77c74e0bbc7fc92.png" width=300>
      </blockquote>

      上のようなテキストの上から2行を以下のように編集したとします。
      
      <blockquote>
        <img src="https://gyazo.com/7f8f023d2b02c9c6ebf967673cbeb488.png" width=300>
      </blockquote>
      
      これは、行頭に「<code>puts "」</code>を入力してから行末に移動して「<code>"</code>」を入力して
      次の行に移動するという操作を2回繰り返した結果ですが、
      ここで
      <img src="https://gyazo.com/371a8ef3f8750394c0eaffa908424810.png" height=22 style="vertical-align:middle;">
      を押すと、
      この操作の繰り返しが検出されてマクロ登録されて実行されるので、
      画面は以下のように変化します。
      
      <blockquote>
        <img src="https://gyazo.com/7c5f44e03e05298992d7afcfe96ef7d4.png" width=300>
      </blockquote>
      
      さらに
      <img src="https://gyazo.com/371a8ef3f8750394c0eaffa908424810.png" height=22 style="vertical-align:middle;">
      を何度か押すと画面は以下のように変化します。
      
      <blockquote>
        <img src="https://gyazo.com/2eca750b4c2c0bde00db42d66c23f5a2.png" width=300>
      </blockquote>
      
      同じように、Dynamic Macroを使うとcsvの編集も簡単です。
      以下のようなcsvテキストのデータの順番を入れ替えることを考えてみます。
      
      <blockquote>
        <img src="https://gyazo.com/91b9e65915843e9ea1c022a265df11b8.png" width=300>
      </blockquote>
      
      「<code>,</code>」を検索して領域を切り取り、
      移動してペーストするという操作を2回繰り返すとテキストは以下のようになります。
      
      <blockquote>
        <img src="https://gyazo.com/ce61be03e477e6e021b291bebc4dd4a3.png" width=300>
      </blockquote>
      
      ここで<code>Ctrl-T</code>を押すと
      繰り返し操作が検出されて実行され、
      テキストは以下のように変化します。
      
      <blockquote>
        <img src="https://gyazo.com/3cb73aa045265e625759d8b1d18fbf4d.png" width=300>
      </blockquote>
      
      さらに何度か<code>Ctrl-T</code>を押すと
      以下のようになります。
      
      <blockquote>
        <img src="https://gyazo.com/12f9a96a6d29e22d64e7ad0ee4942043.png" width=300>
      </blockquote>
      
      このように、複雑な操作であっても、
      同じ操作を2回繰り返した後では
      Dynamic Macroで何度でも連続実行できることになります。
      
      <h3>実装</h3>
      
      Emacsでは<code>(recent-keys)</code>という関数を使って
      最近のキー操作履歴を知ることができます。
      
      繰り返しキーが押されたとき recent-keys を使ってキー操作履歴を取得し、
      繰り返し操作がみつかれば
      それをキーボードマクロとして登録して実行すればよいことになります。
      
      (実行例)
      
      dmacro.elを改良した
      ndmacro.el
      というものが公開されています。
      
      ndmacro.elでは
      1, 2, 3 と入力した後で
      
      
      (実行例)
      
      <h3>AtomのDynamic Macro</h3>
      
      GitHubが開発しているAtomというエディタが
      プログラマの間で人気になっています。
      AtomはJavaScriptベースのElectron上に作成された高機能なエディタで、
      ユーザが自由にJavaScriptやCoffeeScriptで拡張機能を作成することができます。
      
      <blockquote>
        <img src="https://gyazo.com/ec188b77ca139f65ff4890105e0cb78a.png" width=300/>
      </blockquote>
      
      予測インタフェースの難しいところとか書く
      間違える
      完全な予測はできない
      
      予測と検索
      
      

      <hr>
      私は1980年代からEmacsを利用しており、
      その上で20年以上Dynamic Macroを使い続けています。
      Emacs以外のエディタも使ってみたい気持ちは有ったのですが、
      Dynamic Macroが使えないエディタの利用は考えられないので
      ずっとEmacsを使い続けてきていました。
      
      最近AtomでDynamic Macroが動くようになったので、
      これからAtomを利用するようにしようかと考えています。
      この原稿もAtomで書いています。
      
      AtomではHTMLやMarkDownをリアルタイムにプレビューできるところが
      便利ですし、いざとなればJavaScriptで自由に機能を変えられるところは
      プログラマにとって魅力的です。
      また、新しいエディタなので
      GUI対応も充分ですから
      プログラマ以外にも充分薦められるように思います。

    </div>
  </body>
</html>

