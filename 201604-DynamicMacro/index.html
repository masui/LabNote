<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>コロンブス日和 - Dynamic Macro</title>
    <style type="text/css">
      body {
        background-color:#ffffff;
        font-size:12;
        font-family: "Hiragino Kaku Gothic ProN","メイリオ", "sans-serif";
      }
      a { text-decoration: none; }
      li.bold { font-weight: bold; }
      div.body { width:340pt; }
      div.left { float:left; width:10%; font-weight:bold;}
      div.right { width:50%;}
      h1 { background-color:#ddf; padding:8pt;}
    </style>
  </head>

  <body>
    <div class='body'>

      <h1>コロンブス日和 - Dynamic Macro</h1>

      計算機の上で
      同じ作業を何度も繰り返さなければならないことがよくあります。
      計算機は単純な繰り返し作業が得意なはずですが、
      つまらない作業を人間が繰り返さなければならないことは意外と多いものです。
      
      たとえばExcelの表の中の負の数字だけアンダーラインをつけたいときはどうすれば良いでしょうか?
      そういう機能はExeclには用意されてるかもしれませんが、
      知らなければ使えませんし、
      同じような処理であってもシステムに用意されていなければどうしようもありませんから、
      この手の仕事があったときは
      泣きながら手作業で処理したり
      頑張ってスクリプトを書いたりしている人が多いのではないでしょうか。
      
      <p/>
      計算機上の操作を効率化するために
      「<b>予測インタフェース</b>」と呼ばれるシステムが広く使われています。
      スマホのテキスト入力を効率化する「予測入力システム」や
      ブラウザのURL補完機能、エディタの補完機能のような
      簡単な予測インタフェースは最近よく使われていますし、
      これまでの購入履歴をもとにして商品を推薦するシステムなども
      一種の予測システムといえるでしょう。
      
      予測インタフェース研究の歴史は結構古く、
      1993年には
      予測インタフェースの研究をまとめた
      「Watch What I Do」
      という本が出版されていますし、
      最近は
      例示や予測にだけでプログラムを作ってしまおうという研究も行なわれています。
      
      <blockquote>
        <a href="http://www.amazon.co.jp/dp/0262032139"><img src="https://gyazo.com/16fda09b646dbbeffa0672d66f7752f8.png" width=100></a>
        <a href="http://www.amazon.co.jp/dp/1558606882"><img src="https://gyazo.com/7c0a316cb189655ca51f5add5de8e3f0.png" width=100></a>
        <a href="http://www.amazon.co.jp/dp/012381541X"><img src="https://gyazo.com/a723a7e518a93e404ea40366599a8525.png" width=100></a>
        <br/>
        予測インタフェースに関する書籍
      </blockquote>
      
      <p/>
      予測インタフェースシステムでは、
      アプリケーションに関連したデータベースやユーザの操作履歴などをもとにして
      ユーザの次の操作を予測することによって
      ユーザの仕事を減らす工夫をしています。
      
      URL補完の場合はよく使われるURLのデータベースが利用できますし、
      プログラミング言語に関する情報を持っていれば
      ユーザが次に入力する言語キーワードを予測することができます。
      
      このような固定的なデータベースを用意しておくことも重要ですが、
      ユーザの操作履歴を予測のためのデータベースとして利用すると便利です。
      
      ユーザが一度訪れたサイトのURLを覚えておけば補完に利用できますし、
      予測入力システムではユーザが利用した単語やフレーズが次の予測に利用されます。
      
      前述のExcelの例のような場合、
      負の数字にアンダーラインをつける操作が繰り返されていることをシステムが検出できれば
      ユーザの次の操作を予測することができるでしょう。
      
      <h2>編集作業の効率化</h2>
      
      文章やプログラムのようなテキストを編集するとき、
      同じような操作を繰り返すことがよくあります。
      
      例えば、連続する行の先頭に記号を挿入したいような場合は
      カーソルを1行ずつ動かして記号を入力していくのが普通ですが、
      沢山の行に対して同じ操作を繰り返すのは大変です。
      行頭に記号を挿入するスクリプトを書けば良いのかもしれませんが、
      一度きりかもしれない処理のためにプログラムを作成するのは面倒ですし、
      プログラミングの知識が必要です。
      
      また、csvデータの桁を並び替えたいときはどうでしょうか?
      csvデータをExcelなどで読み取ってから並びを変えて出力すれば良いかもしれませんが、
      方法を考えるのも実際に作業するのも面倒です。

      <h3>キーボードマクロ</h3>
      
      このような作業を簡単にするために
      「キーボードマクロ」という機能が用意されているエディタがあります。
      キーボードマクロとは、一連のエディタ操作をひとつのキー操作に割り当てることにより、
      複雑な編集操作を楽に実行しようというものです。
      
      例えば「行頭に記号を挿入してからひとつ下の行に移動する」という処理を
      Aというキーに割り当てておけば、
      Aを連打することによって連続する行の先頭に記号を入力していくことができますし、
      「カンマで区切られた部分を選択して移動してから次の行に移動する」という処理を
      Bというキーに割り当てておけば、
      Bを連打することによってcsvの桁を入れ替えていくことができます。
      
      <p/>
      キーボードマクロは便利な機能ですが、
      キーボードマクロの定義開始と終了のための操作が必要であるうえに、
      処理を正確に登録するのが難しいという問題があります。
      たとえば前述の例の場合、
      「ひとつ下の行に移動する」処理を定義に含めることを忘れてしまうと正しく動きません。
      
      <h2>Dynamic Macro</h2>
      
      キーボードマクロの機能をもっと簡単に使えるようにするため、
      私は
      キーボードの繰り返し操作から次の操作を予測して
      自動的にキーボードマクロとして登録することができる
      Dynamic Macro
      というシステムを作って長年Emacsの上で利用しています。
      
      <p/>
      Dynamic Macroの原理は非常に単純で、
      
      <blockquote>
      「同じ編集操作を2回繰り返した後で
      <img src="https://gyazo.com/371a8ef3f8750394c0eaffa908424810.png" height=22 style="vertical-align:middle;">
      を押すと繰り返された操作が再実行される」
      </blockquote>
      
      というものです。

      「二度あることは三度ある」と言うように、
      同じことが二度あればもう一度あるのは世の中でごく普通のことです。
      二度実行した操作をもう一度実行することもよくあることなので、
      この方法は大変効果的です。

      <h3>Dynamic Macroの利用例</h3>
      
      Emacs上に実装したDynamic Macroの利用例を示します。
      
      下の図はEmacsで<code>abcabc</code>と入力したところです。
      
      <blockquote>
        <img src="https://gyazo.com/18625ae67a38b3092141ddefaf07d279.png" width=300>
      </blockquote>
      
      ここで
      <img src="https://gyazo.com/371a8ef3f8750394c0eaffa908424810.png" height=22 style="vertical-align:middle;">
     
      を押すと、
      Emacsのキー操作履歴から
      <code>abc</code>入力の繰り返しが検出され、
      キーボードマクロとして登録されて実行され、
      以下のようにもうひとつ<code>abc</code>が挿入されます。
      
      <blockquote>
        <img src="https://gyazo.com/7e6818299af63bada73a03ca49a8fd12.png" width=300>
      </blockquote>
      
      再度
      <img src="https://gyazo.com/371a8ef3f8750394c0eaffa908424810.png" height=22 style="vertical-align:middle;">
      を押すと、
      以下のようにまた<code>abc</code>が入力されます。
      
      <blockquote>
        <img src="https://gyazo.com/dfbb2878d8cc5af1e57a9076c2415c36.png" width=300>
      </blockquote>
      
      これは単純な例でしたが、Dynamic Macroはもっと複雑な編集操作でも使うことができます。
      
      <blockquote>
        <img src="https://gyazo.com/5b6db6ef31dd1300c77c74e0bbc7fc92.png" width=300>
      </blockquote>

      上のようなテキストの上から2行を以下のように編集したとします。
      
      <blockquote>
        <img src="https://gyazo.com/7f8f023d2b02c9c6ebf967673cbeb488.png" width=300>
      </blockquote>
      
      これは、行頭に「<code>puts "</code>」を入力してから行末に移動して「<code>"</code>」を入力して
      次の行に移動するという操作を2回繰り返した結果ですが、
      ここで
      <img src="https://gyazo.com/371a8ef3f8750394c0eaffa908424810.png" height=22 style="vertical-align:middle;">
      を押すと、
      この操作の繰り返しが検出されてマクロ登録されて実行されるので、
      画面は以下のように変化します。
      
      <blockquote>
        <img src="https://gyazo.com/7c5f44e03e05298992d7afcfe96ef7d4.png" width=300>
      </blockquote>
      
      さらに
      <img src="https://gyazo.com/371a8ef3f8750394c0eaffa908424810.png" height=22 style="vertical-align:middle;">
      を何度か押すと画面は以下のように変化します。
      
      <blockquote>
        <img src="https://gyazo.com/2eca750b4c2c0bde00db42d66c23f5a2.png" width=300>
      </blockquote>
      
      同じように、Dynamic Macroを使うとcsvの編集も簡単です。
      以下のようなcsvテキストのデータの順番を入れ替えることを考えてみます。
      
      <blockquote>
        <img src="https://gyazo.com/91b9e65915843e9ea1c022a265df11b8.png" width=300>
      </blockquote>
      
      「<code>,</code>」を検索して領域を切り取り、
      移動してペーストするという操作を2回繰り返すとテキストは以下のようになります。
      
      <blockquote>
        <img src="https://gyazo.com/ce61be03e477e6e021b291bebc4dd4a3.png" width=300>
      </blockquote>
      
      ここで
      <img src="https://gyazo.com/371a8ef3f8750394c0eaffa908424810.png" height=22 style="vertical-align:middle;">
      を押すと
      繰り返し操作が検出されて実行され、
      テキストは以下のように変化します。
      
      <blockquote>
        <img src="https://gyazo.com/3cb73aa045265e625759d8b1d18fbf4d.png" width=300>
      </blockquote>
      
      さらに何度か
      <img src="https://gyazo.com/371a8ef3f8750394c0eaffa908424810.png" height=22 style="vertical-align:middle;">
      を押すと
      以下のようになります。
      
      <blockquote>
        <img src="https://gyazo.com/12f9a96a6d29e22d64e7ad0ee4942043.png" width=300>
      </blockquote>
      
      このように、複雑な操作であっても、
      同じ操作を2回繰り返した後では
      Dynamic Macroで何度でも連続実行できることになります。
      
      <h3>Dynamic Macroの特徴</h3>
      
      Dynamic Macroは
      繰り返し操作を効率化するシステムですが、
      予測インタフェースの考え方を
      キーボードマクロに応用したものだともいえます。
      
      ユーザの繰り返し操作をもとにして次の操作を「予測」し、
      それをキーボードマクロのように利用できるからです。
      
      予測と言っても
      繰り返し操作からの「予測」なので
      誤った予測をしてしまう可能性はほとんどありません。
      
      <p/>
      キーボードマクロと比較すると
      Dynamic Macroには以下のような利点があります。
      
      <ul>
        <li>使うキーが
          <img src="https://gyazo.com/371a8ef3f8750394c0eaffa908424810.png" height=22 style="vertical-align:middle;">
          ひとつだけ</li>
        
        <li>定義の開始と終了を正確に指定する必要がない</li>
        
        繰り返し操作中のどこで
        <img src="https://gyazo.com/371a8ef3f8750394c0eaffa908424810.png" height=22 style="vertical-align:middle;">
        を押しても操作が再実行されます。

        <li>操作を行なった後で繰り返し実行を指示できる</li>

        普通のキーボードマクロを利用する場合、
        これから繰り返し操作を行なうぞ、と意識して登録を開始する必要がありますが、
        Dynamic Macroの場合は操作の後で繰り返しに気付いて
        再実行させることができます。
      </ul>
      
      
      <h3>Emacsでの実装</h3>
      
      Dynamic Macroは最初はEmacsの上で実装されました。
      
      Emacsでは<code>(recent-keys)</code>という関数を使って
      最近のキー操作履歴を知ることができるので、
      繰り返しキーが押されたとき
      この機能を使ってキー操作履歴を取得し、
      繰り返し操作がみつかれば
      それをキーボードマクロとして登録して実行すればよいことになります。
      
      <p/>
      <code>dmacro.el</code>を改良した
      <a href="https://github.com/snj14/ndmacro.el">ndmacro.el</a>
      というシステムも公開されています。
      <code>ndmacro.el</code>では
      <code>1</code>, <code>2</code>, <code>3</code> と入力した後で
      <img src="https://gyazo.com/371a8ef3f8750394c0eaffa908424810.png" height=22 style="vertical-align:middle;">
      を押すと
      <code>4</code>, <code>5</code>, <code>6</code>, ...
      のように、
      連続する文字列を入力していくことができます。
      
      <h3>Atomでの実装</h3>
      
      GitHubが開発している
      <a href="http://atom.io/">Atom</a>
      というエディタが最近プログラマの間で人気が出ています。
      AtomはJavaScriptとブラウザ技術をベースに作成されたモダンで高機能なエディタで、
      ユーザが自由にJavaScriptやCoffeeScriptで拡張機能を作成することができます。
      
      Atomの拡張機能を利用することによって、
      Atom上でもDynamic Macroを利用できます。
      
      <blockquote>
        <img src="https://gyazo.com/ec188b77ca139f65ff4890105e0cb78a.png" width=300/>
      </blockquote>
      
      Atomには
      <code>(recent-keys)</code>
      のような履歴保存機能は用意されていないので、
      <code>addEventListner()</code>
      のような機能を使って
      操作履歴は自力で覚えておくようにしています。
      
      <h2>予測インタフェースの難しいところ</h2>

      予測インタフェースは便利なものですが、
      あくまで「予測」なので、
      システムの予測がユーザの意図と異なる可能性が常に存在します。
      
      ユーザが
      <code>1</code>, <code>2</code>, <code>3</code>,
      <code>1</code>, <code>2</code>, <code>3</code>
      と入力したとき、
      ユーザが次に入力したいのが
      <code>1</code>なのか<code>4</code>なのかはユーザ本人にしかわかりません。
      高度な予測を行なおうとすると、
      予測を間違える可能性が高くなりますし、
      複数の予測結果から希望するものを選択する必要が出てくるかもしれませんから、
      便利さと簡単さのバランスが重要になってきます。
      
      <p/>
      予測入力システムの場合、
      ユーザが入力したい単語が常に第一候補として提示されるわけではありませんが、
      欲しい単語が候補リストに含まれている可能性が高ければ
      それほどユーザは不満を感じません。
      
      一方、正しく予測されることへの期待が大きいのにもかかわらず
      頻繁に間違った予測が実行されてしまうようであれば、
      ユーザの失望が大きいため
      予測システムの利用をあきらめてしまうかもしれません。
      
      予測インタフェース研究は長いにもかかわらず
      最近まであまり利用されていなかったのは
      こういう理由が大きいと思われます。
      
      Dynamic Macroの場合、
      全く同じ操作を繰り返すだけなので
      間違った予測が実行されることはほとんどないのですが、
      それでも間違えることが皆無ではありません。
      
      もっと微妙な予測の場合は
      システムが間違った予測をしてしまうことは多いでしょう。
      
      <p/>
      Dynamic Macroのような予測機能は
      実世界の様々な場所で使える可能性があります。
      同じ設定で二回動かしたらその設定を繰り返せる洗濯機が売られていたことがありますし、
      同じフレーズを二回弾いたら何度も繰り返してくれるピアノが作れるかもしれません。
      いろんな予測機能を有効に使うことによって
      世の中の単調作業を何でも効率化していきたいものです。

      <!--
      実世界のDynamic Macro
      毎年2/14にチョコを買ってる人がいれば
      次の年もチョコを買うことを薦めれば良いかもしれませんが、
      もうチョコなど必要なくなってる可能性もある
      -->

      <h4>(おまけ)</h4>
      
      私は1980年代からEmacsを利用しており、
      その上で20年以上Dynamic Macroを使い続けています。
      Emacs以外のエディタも使ってみたい気持ちは有ったのですが、
      Dynamic Macroが使えないエディタの利用は考えられないので
      ずっとEmacsを使い続けてきていました。
      
      最近AtomでDynamic Macroが動くようになったので、
      これからAtomを利用するようにしようかと考えています。
      (この原稿もAtomで書いています。)
            
      EmacsもAtomももともとプログラマ向けに開発されたエディタですが、
      Atomは30年(!)後発なだけに、
      Emacsに比べると利用のハードルは低いですし、
      GUI的な機能もしっかりしており、
      万人に薦められるものに進化しつつあります。
      
      これからはAtom上で誰もが便利に使える他のツールの作成にも
      挑戦したいと思っています。
      
      <h4>今回のソフトウェアの公開場所</h4>
      
      <ul>
        <li><a href="https://github.com/masui/DynamicMacro">Emacs版Dynamic Macro</a></li>
        <li><a href="https://github.com/masui/atom-dynamic-macro">Atom版Dynamic Macro</a></li>
      </ul>

    </div>
  </body>
</html>

