<!--
    http://www.mew.org/~kazu/doc/newsletter/3.html MIMEについて
-->
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>コロンブス日和 - Gyamm</title>
    <style type="text/css">
      body { background-color: #eee; }
      a { text-decoration: none; }
      li.bold { font-weight: bold; }
      div.body { width:400pt; }
      div.left { float:left; width:10%; font-weight:bold;}
      div.right { width:50%;}
    </style>
  </head>
  
  <body>
    <div class='body'>
      
      <h1>コロンブス日和 - Gyamm</h1>

      先月号の記事でも書いたように、
      世の中のあらゆるものがURLで表現可能になりつつあります。
      製品にも日記にもレシピにも場所にもURLがついており、
      あらゆる情報がURLで表現できる時代になってきたといえるでしょう。

      <p/>
      ところが何故かメールメッセージにアクセスするのに
      URLを使うのは一般的ではなく、
      メール専用のアプリケーションやサービスを利用するのが普通で、
      なにかと不便が多い状況になっています。
      <!--
      メールは個人的なものだから
      それが普通だと思われているのかもしれませんが、
	-->
      たとえば
      会議やイベントの連絡をメールで受け取ったとき、
      その内容を表現するURLは存在しませんから、
      ブックマークすることができませんし、
      SNSなどにURLを貼ることができませんし、
      別のページやWikiなどからリンクを張ることもできません。

      GMailのようなWebメールサービスを使えば
      ブラウザからメールメッセージを参照することができる場合もありますが、
      他人にURLを渡すことができないのは不便です。
      
      メールで個人的に受け取った情報を他人に伝えようとすると、
      メールを転送したり
      SNSにコピペしたりしなければなりません。

      あらゆる情報がWeb上で表現されている現在、
      情報に直接ブラウザからアクセスできないのは大変不便であり、
      <b>メールで受け取った情報だけが別の世界に存在するように感じられてしまいます。</b>

      <p/>
      そもそもメールがWebと同じ世界に存在して
      直接リンクを張ることができるのならば
      こういう面倒は不要なはずです。
      メールの世界が別世界で閉じていることが問題であり、
      あらゆる情報をURLで一括管理できれば
      メール情報の扱いの面倒さは解消するはずです。

      <p/>
      メールとWebの相性が悪い原因は以下のようなものだと思われます。

      <ul>
	<li>メールはWebより前から存在しており、独自の環境で扱われていた</li>
	<li>メールは個人的な情報のやりとりに使わることが多かったため
	  公開が前提のWebの世界とは別物と考えられていた</li>
      </ul>

      このような事情のため、
      Webと融合する方法があまり工夫されていなかったのでしょう。

      <p/>
      メールが使われはじめたのはWebの開発よりもずっと前のことなので、
      別世界の話なのは仕方がなかったかもしれませんが、
      Webが発明されてから20年以上経過している現在、
      いつまでもメールを別世界のまま放置しておくわけにはいかないでしょう。
      なんらかの方法での融合が必要だと思われます。

      <h2>Gyamm - メールメッセージをWebページ化する</h2>

      メールメッセージを普通のWebページと同じように扱うことができれば
      メールの扱いはずっと便利になるはずです。
      私はメールを簡単にWebページに変換できる
      <a href="http://Gyamm.com/"><b>Gyamm</b></a>というシステムを作って運用しています。

      <blockquote>
	<!-- <img src="https://gyazo.com/94f7c86aa2094e9c6b417cbfa8f47dfb.png" width=500><br/> -->
	<img src="https://gyazo.com/75f08012bbe2960be05b9872933016e3.png" width=500><br/>
	Gyamm
      </blockquote>

      Gyammでは
      GMailのようなWebメールシステムと異なり、
      メッセージは普通のHTMLのページに変換されるので、
      どこからでも普通にブラウザからアクセスが可能です。

      <h3>Gyammの使い方</h3>
	
      Gyammの使い方はとても簡単です。
      メールメッセージを
      <i>example</i><code>@gyamm.com</code>
      のようなメールアドレスに送ると、
      送られたメッセージは
      <code>http://gyamm.com/</code><i>example</i>
      から閲覧できるWebページに変換されます。
      メールが添付ファイルを含んでいたり
      HTMLメールだったりした場合でも
      普通にWebページとして閲覧することができます。

      <p/>
      たとえば受け取ったHTMLメールを
      <code>example@gyamm.com</code>
      に送ると、
      以下のようなWebページが生成されて
      <a href="http://gyamm.com/example/20151119003655"><code>http://gyamm.com/example/20151119003655</code></a>
      のようなURLでアクセスできます。

      メールの情報を簡単な手間でWebで公開できたことになります。

      <blockquote>
	<!--
	<img src="https://gyazo.com/09e2428331c6f3078902f6c6e9552ccd.png" width=500><br/>
	不動産業者から受け取ったHTMLメールをGyammでWebページに変換したもの
	-->
	<img src="https://gyazo.com/b30e4ca7ad6f359a78b856d8b07c8299.png" width=500><br/>
	書店からの案内メール
      </blockquote>

      <h3>Gyammの利用例</h3>

      このように、
      Gyammを使うと
      任意のメールメッセージを簡単にWebページに変換できるので、
      以下のような様々な用途に利用することができます。

      <ul>
	<li class="bold">情報の公開/共有</li>

	<p/>
	受け取ったメールをそのままの型式でWebページで公開するのは普通は簡単ではありませんが、
	Gyammを利用すれば
	HTMLメールも添付ファイルつきメールも
	Webページに変換して
	ブックマークしたり他人と共有したりできます。
	<!-- ブラウザから簡単にアクセスすることができます。 -->

	<p/>
	<li class="bold">メーリングリストのアーカイブ</li>

	<p/>
	<code>xxxx</code>
	という名前のメーリングリストのメンバとして
	<code>xxxx-archive@gyamm.com</code>
	のようなアドレスを登録しておくと、
	メーリングリストのあらゆるメッセージが
	<code>xxxx-archive@gyamm.com</code>
	に送られ、その結果全メッセージが
	<code>http://gyamm.com/xxx-archive/</code>
	に蓄積されるので、
	メッセージのアーカイブとして利用することができます。

	<p/>
	<li class="bold">フロー情報のストック化</li>

	<p/>
	宴会などの案内がメールで送られてくることはよくありますが、
	こういうフロー情報をWebページのようなストック情報に変換しておくと
	後でアクセスしやすくなって便利です。
	
	<blockquote>
	  <!-- <img src="https://gyazo.com/9238a6769ad77eb0c5feb7a180f25079.png" width=400><br/> -->
	  <img src="https://gyazo.com/d0e5e0b8cfb47ed48a4635f3dff2dfa9.png" width=400><br/>
	  宴会メールをWebページに変換したもの
	</blockquote>
	
	このようにメッセージをWebページ化しておけば、
	先月号で紹介したGyumpを使って
	<code>http://Gyump.com/masui/enkai</code>
	のようなURLでアクセスできるようになります。
    
	<p/>
	<li class="bold">情報の集約</li>

	<p/>
	何かのトピックに関して様々な人からメールを受け取ったとき、
	それを全部
	<code>special-topic@gyamm.com</code>
	のようなアドレスに転送するようにしておけば、
	関連するあらゆるメールを
	<code>http://gyamm.com/special-topic/</code>
	からアクセスできるようになります。
	
	アンケートやレポートをメールで集計するような場合に便利です。

	<p/>
	<li class="bold">情報の分類管理</li>

	<p/>
	仕事に関するメールなど、
	やらなければならない仕事は全部
	<code>masui-todo@gyamm.com</code>
	に転送することにしておけば、
	やらなければならない仕事をすべてGyamm上にリストすることができます。

	Gyammではメールが表示されないように指定できるので、
	終わった仕事に関するメールは非表示にしておけばよいでしょう。

	同様に、トピックごとに別のGyammアドレスに送るようにすれば
	フォルダのように管理することができます。

	<!--
	<li class="bold">メールで送られてきた地図にブラウザからアクセスする</li>
	<li class="bold">自分が受け取ったメルマガ記事を保存する</li>
	<li class="bold">ネットサービスからの返信を保存する</li>
	-->

      </ul>

      <h2>Gyammの実装</h2>

      Gyammは以下のように実装されています。

      <ol>
	<li>SMTPを解釈するGyammサーバをgyamm.comで動かし、???@gyamm.com宛のメールをすべて受け取る</li>
	<li>届いたメッセージを解析してHTMLに変換する</li>
      </ol>

      SMTP (Simple Mail Transfer Protocol)は
      インターネットのメール転送で標準的に利用されているプロトコルで、
      メール送信アプリケーションや
      Postfixのようなメール転送エージェント(MTA)で広く利用されています。
      
      Gyammはメールサーバではありませんが、
      SMTPを解釈してメールサーバのふりをすることによって
      Gyamm.comへのメールを受け取って処理しています。

      <h3>SMTPサーバの実装</h3>

      <!-- Gyamm.comに対してメールを送れるようにするためにSMTPサーバを動かしています。 -->
      SMTPの仕様は
      <a href="https://tools.ietf.org/html/rfc821">RFC821</a>
      で定義されています。
      SMTPサーバには25番ポートを利用して
      以下のように対話的にアクセスすることができます。
      (太字がユーザ入力です)

      <blockquote>
	<pre>
	  % <b>telnet gyamm.com 25</b>
	  Trying 133.242.135.184...
	  Connected to gyamm.com.
	  Escape character is '^]'.
	  220 gyamm.com ESMTP GYAMM
	  <b>HELO example.com</b>
	  250 gyamm.com
	  <b>MAIL FROM: masui@pitecan.com</b>
	  250 ok
	  <b>RCPT TO: masui@example.com</b>
	  250 ok
	  <b>DATA</b>
	  354 send the mail data, end with .
	  <b>From: masui@pitecan.com
	  To: masui@example.com
          
	  Hello
	  .</b>
	  250 ok
	  <b>QUIT</b>
	  221 Bye
	  Connection closed by foreign host.
	  %
	</pre>
      </blockquote>

      <p/>
      正式なSMTPサーバはメール転送などの処理をする必要がありますが、
      Gyammサーバはメールを受け取ってデータを処理するだけなので
      実装はそれほど複雑ではありません。
      上記のようなやりとりができるようにするために
      以下のようなコマンド(SMTPの仕様の一部)を実装しておけば大丈夫です。

      <blockquote>
	<div style="border-width:1; border-style:solid; padding:2; background-color:#fff;">
	  <div class="left">HELO</div><div class="right">通信開始</div>
	  <div class="left">MAIL</div><div class="right">送信アドレスを指定</div>
	  <div class="left">RCPT</div><div class="right">受信アドレスを指定</div>
	  <div class="left">DATA</div><div class="right">メッセージ本文を指定</div>
	  <div class="left">QUIT</div><div class="right">通信切断</div>
	</div>
	SMTPの仕様の一部
      </blockquote>

      <h3>メールをHTMLに変換</h3>

      <code>DATA</code>コマンドによって
      メールのメッセージの本体が送られます。
      
      <code>Subject:</code>
      や
      <code>From:</code>
      のようなメールヘッダもこの中に含まれます。

      メールのヘッダと本文を適切にデコードして解析してHTMLに変換することによって
      Webブラウザから読めるようになります。
      
      <h4>MIME</h4>
      
      SMTPでやりとりするメッセージ本体では
      ASCIIテキストしか利用できないため、
      日本語テキストやバイナリデータを含めることはできません。
      
      日本語を含むタイトルや添付ファイルを利用するときは
      <b>MIME型式</b>へのエンコーディングが用いられています。

      <p/>
      メールのSubject(タイトル)に日本語を利用したり
      画像や文書などをメールに添付するのは
      現在あたりまえになっていますが、
      もともとのメールの規格では
      タイトルも本文もASCII文字しか利用することができませんでした。

      インターネットのメールが世の中に普及しはじめた1980年代は、
      メールの本文にJISコードを利用することにより
      なんとか日本語のメッセージを送ることはできましたが、
      正式な規格ではないので微妙なところがありました。

      また、パソコン通信などの非インターネットの世界では
      タイトルや本文にShiftJISの日本語が利用されていることが多く、
      メールの世界はかなり混沌とした状態になっていました。

      <p/>
      1990年ごろまではそういう状況が続いていたのですが、
      1996年にMIME規格が
      <a href="https://tools.ietf.org/html/rfc2045">RFC2045</a>
      として制定されたおかげで、
      任意の言語をタイトルや本文に利用したり
      メッセージにファイルを含めたりできるようになりました。

      既存のメール配信システムを変更することなくデータをマルチメディア化するため、
      MIMEでは以下のような方法によって
      様々なデータをメールメッセージとして送れるようになっています。

      <ul>
	<li>データ型の指定</li>
	Content-Type:フィールドでデータ型や文字コードを指定する。
	<li>データのエンコード</li>
	画像や文書など任意のデータをテキスト型式に変換する方法を定義。
	<li>データの階層的な構造化</li>
	マルチパートというデータ型で複数のデータをまとめて扱う。
	複数のパートをまとめたデータを
	上位データのパートとすることもえきるので
	階層的なデータ構造を表現できる。
	<li>ヘッダの国際化</li>
	任意の文字コードをヘッダで利用できるエンコード方式を定義。
      </ul>

      <h4>MIMEのエンコード</h4>

      Gyaimでは
      MIME型式で送られてきたメールをデコードして、
      人間が読める形に変換しています。
      テキストは普通のHTMLテキストに変換し、
      それ以外のものは添付ファイルとしてリストするようにしています。

      <p/>
      MIME型式で送られてきたメールメッセージを
      HTMLファイルに変換するには以下の処理が必要です。

      <ul>
	<li>ヘッダ文字列のデコード</li>
	<li>MIMEパートの分離/デコード</li>
	<li>埋め込み画像の変換</li>
      </ul>

      HTMLファイルや添付画像ファイルは
      パートに分けてMIMEメッセージにすることができますが、
      ひとつのパートのHTMLから別パートの画像を参照するための特殊なimgタグを
      通常のimgタグに変換する必要があります。

      <!---
      画像を含むWebページのHTMLと画像をまとめてMIME化したいときのために、
      通常のimgタグのかわりに
      MIME内の別パートの画像を参照する特殊なimgタグを利用することにより、
      画像を含むWebページをひとつのHTMLメールとしてMIMEエンコードすることができるようにもなっています。
	-->

      <h2>Gyammの将来</h2>

      Gyammは大変便利なものですが、
      SMTPやMIMEの扱いのため実装は若干複雑になってしまい、
      コロンブス指数が低い結果になってしまいました。

      将来のコミュニケーションはすべてWebベースになるでしょうから
      メールは次第に廃れていくと考えられ、
      Gyammのようなシステムも不要になると思われます。

      しかしメールが完全に無くなるにはまだ10年はかかるでしょうから、
      それまでは充分利用価値があると思います。
      
    </div>
  </body>
</html>
