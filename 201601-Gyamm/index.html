<!--
    http://www.mew.org/~kazu/doc/newsletter/3.html MIMEについて
-->
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>コロンブス日和 - Gyamm</title>
    <style type="text/css">
      body { background-color: #eee; }
      a { text-decoration: none; }
      li { font-weight: bold; }
      div.body { width:400pt; }
    </style>
  </head>
  
  <body>
    <div class='body'>
      
      <h1>コロンブス日和 - Gyamm</h1>

      先月号の記事でも書いたように、
      最近はあらゆるものがURLで表現可能になりつつあります。
      製品にも本にも日記にもレシピにも場所にも人間にもURLがついており、
      あらゆる情報へのポインタがURLで表現できる時代になってきたといえるでしょう。

      <p/>
      ところが何故かメールメッセージにアクセスするのにURLを使うのは一般的ではありません。
      メールは個人的なものだから
      それが普通だと思われているのかもしれませんが、
      考えてみると不便な話です。
      会議やイベントの連絡がメールで送られてきたとき、
      その情報を表現するURLは存在しませんから、
      別の場所からその情報にリンクを張ることができませんし
      ブックマークすることもできません。
      面白い情報をメールで貰ったとき、
      それを他人に伝えようとするとメールの転送が必要で、
      そのようなデータにブラウザからアクセスできないのは面倒です。
      あらゆる情報の中でメール情報だけが別の世界にいるかのようです。

      <p/>
      GMailのようなWebメールサービスを使えば
      ブラウザからメールメッセージを参照することができる場合もありますが、
      他人にURLを渡すことができません。

      <p/>
      文書などのデータは普通にWebで公開できるのに対し、
      メールを公開するにはコピペなどのデータ変換が必要になります。
      そもそもメールがWebと同じ世界に存在して
      直接リンクを張ることができるのならば
      こういう面倒は不要なはずです。
      メールだけが別世界にいることが問題であり、
      あらゆる情報をURLで一括管理できれば
      メール情報の扱いの面倒さは解消するはずです。

      <p/>
      メールとWebの相性がいまひとつなのは
      以下のような理由のためと思われます。

      <ul>
	<li>メールはWebより前から存在し、独自の使われ方が常識になっていた</li>
	<li>メールは主に個人的な情報のやりとりに使われることが多い</li>
      </ul>

      という事情のため融合方式があまり考えられていないからだと思います。

      <p/>
      メールが開発されたのはWebが開発されるよりもずっと前のことなので、
      別世界の話なのは仕方がなかったかもしれません。
      しかしWebが発明されて20年以上経過している現在、
      いつまでもメールを別世界のまま放っておくわけにはいかないでしょう。
      なんらかの方法での融合が必要だと思われます。

      メールメッセージを普通のWebページのように扱うことができれば
      メールの扱いは現在よりずっと簡単になります。

      <h2>Gyamm - メールメッセージをWebページ化する</h2>

      前述のような問題を解決するために、
      メールを簡単にWebページに変換できる
      <b>Gyamm</b>というシステムを作って運用しています。
      
      GMailのようなWebメールシステムと異なり、
      メッセージは普通のHTMLのページに変換されるので、
      どこからでもアクセスが可能です。

      <h3>Gyammの使い方</h3>
	
      Gyammの使い方はとても簡単です。
      メールメッセージを
      <code>(好きな名前)@gyamm.com</code>
      に送ると、
      送られたメッセージは
      <code>http://gyamm.com/(好きな名前)</code>
      から閲覧できるWebページに変換されます。
      メールが添付ファイルを含んでいたり
      HTMLメールだった場合でも
      普通にWebページとして閲覧することができます。

      <p/>
      たとえば受け取ったHTMLメールを
      <code>example@gyamm.com</code>
      に送ると、
      以下のようなWebページが生成されて
      <code>http://gyamm.com/example/20110505153134</code>
      のようなURLでアクセスできます。

      <blockquote>
	<img src="https://gyazo.com/09e2428331c6f3078902f6c6e9552ccd.png" width=500><br/>
	不動産屋からのHTMLメールをGyammでWebページに変換したもの
      </blockquote>

      <h2>Gyammの利用例</h2>

      このように、
      Gyammを使うと
      任意のメールメッセージを簡単にWebページに変換できるので、
      以下のような様々な用途に利用することができます。

      <ul>
	<li>自分宛のメールをWebページとして公開する</li>

	受け取ったメールをそのままの型式でWebページで公開するのは普通は簡単ではありませんが、
	Gyammを利用すれば
	HTMLメールも添付ファイルつきメールも
	Webページに変換して
	ブラウザから簡単にアクセスすることができます。
	
	<li>メールのアーカイブ</li>

	<code>xxxx</code>
	という名前のメーリングリストのメンバとして
	<code>xxxx-archive@gyamm.com</code>
	のようなアドレスを登録しておくと、
	メーリングリストのあらゆるメッセージが
	<code>http://gyamm.com/xxx-archive/</code>
	に蓄積されるので、
	メッセージのアーカイブとして利用することができます。

	<li>イベントや宴会の案内メールをブラウザで読めるようにする</li>

	宴会などの案内がメールで送られてくることはよくありますが、
	こういうストック情報はブラウザからアクセスできたほうが便利です。
	
	<blockquote>
	  <img src="https://gyazo.com/9238a6769ad77eb0c5feb7a180f25079.png" width=400><br/>
	  宴会メールをWebページに変換したもの
	</blockquote>
	
	このようにメッセージをWebページ化しておけば、
	前回紹介したGyumpなどからアクセスするするのも簡単です。
    
	<li>関連メールをまとめる</li>

	何かのトピックに関して様々な人からメールを受け取ったとき、
	それを全部
	<code>special-topic@gyamm.com</code>
	に転送するようにしておけば、
	関連するあらゆるメールを
	<code>http://gyamm.com/special-topic/</code>
	からアクセスできるようになります。
	
	アンケートやレポートなどをメールで集計するような場合に便利でしょう。

	<li>TODO情報をまとめておく</li>

	仕事に関するメールなど、
	やらなければならない仕事は全部
	<code>masui-todo@gyamm.com</code>
	に転送することにしておけば、
	やらなければならない仕事をすべてGyamm上にリストすることができます。

	Gyammではメールが表示されないように指定できるので、
	終わった仕事に関するメールは非表示にしておけばよいでしょう。

	<li>メールで送られてきた地図にブラウザからアクセスする</li>
	
	<li>自分が受け取ったメルマガ記事を保存する</li>
	
	<li>ネットサービスからの返信を保存する</li>

	フォルダみたいなののかわりに使う
	どこからでもアクセスできるので便利
      </ul>

      <h2>Gyammの実装</h2>

      このようにGyammの使い方はとても簡単ですが、
      実装はちょっと面倒です。

      <ol>
	<li>SMTPと同じ動作をするGyammサーバをgyamm.comで動かす</li>
	<li>そこに届いたメッセージを解析してHTMLファイルに変換する</li>
      </ol>

      <h3>SMTPサーバの実装</h3>

      Gyamm.comに対してメールを送れるようにするためにSMTPサーバを動かしています。
      SMTPの仕様はRFCxxxxで定義されています。

      SMTPサーバは以下のような動作をします。

      <blockquote>
	<pre>
	  % telnet gyamm.com 25
	  HELO
	  FROM
	</pre>
      </blockquote>

      <p/>
      本当のSMTPサーバはメール転送などの処理をする必要がありますが、
      Gyammサーバはメールを受け取るだけなので、
      data
      で送られてきたメッセージを解析して
      HTMLに変換すればよいので
      実装はそれほど難しくありません。

      <h3>メールをHTMLに変換</h3>

      Gyammサーバで受け取ったメールをWebサーバで読める形のHTMLファイルに変換するためには
      以下の処理が必要です。

      <ul>
	<li>ヘッダのデコード</li>
	<li>MIMEパートの分離</li>
	<li>MIMEパートのデコード</li>
	<li>埋め込み画像の変換</li>
      </ul>
      
      現在はメールのSubject(タイトル)に日本語を利用したり
      画像や文書などをメールに添付するのはあたりまえになっていますが、
      もともとのメールの規格では
      タイトルも本文もASCII文字しか利用することができないことになっていました。

      インターネットの黎明時代には
      メールの本文にJISコードを利用することにより
      なんとか日本語のメッセージを送ることはできましたが、
      正式な規格からははずれていましたし、

      一方、パソコン通信などの非インターネットの世界では
      タイトルや本文にShiftJISの日本語が利用されていることが多く、
      かなり混沌とした状態になっていました。
      
      <h4>MIMEについて</h4>
      
      1990年ごろまではそういう状況が続いていたのですが、
      1992に
      CMUのNathaniel S. Borensteinらによって
      MIME規格がRFCxxxxとして制定されたおかげで
      任意の言語をタイトルや本文に利用したり、
      メッセージにファイルを含めたりできるようになりました。

      既存んメール配信システムを変更することなくデータをマルチメディア化するため、
      MIMEでは以下のような方法によって
      様々なデータをメールメッセージとして送れるようになっています。

      <ul>
	<li>データ型の指定</li>
	Content-Type:フィールドでデータ型や文字コードを正確に指定する
	<li>データのエンコード</li>
	画像や文書など任意のデータをテキスト型式に変換する方法を定義
	<li>データの階層な構造化</li>
	マルチパートというデータ型を使って、複数のデータをまとめて扱えるようにしました
	複数パートをまとめたデータ全体を、ひとつ上位の一部分とすることもえきるので
	階層的なデータ構造を表現できます。
	<li>ヘッダの国際化</li>
	任意の文字コードの文字列をヘッダで利用できるエンコード方式を定義
      </ul>

      HTMLファイルや画像ファイルは上の方法で
      パートに分けてMIMEメッセージにすることができますが、
      画像を含むWebページのHTMLと画像をまとめてMIME化したいときのために、
      通常のimgタグのかわりに
      MIME内の別パートの画像を参照する特殊なimgタグを利用することにより、
      画像を含むWebページをひとつのHTMLメールとしてMIMEエンコードすることができるようにもなっています。

      <h4>MIMEのデコード</h4>

      Gyaimでは
      MIME型式で送られてきたメールをデコードして、
      人間が読める形に変換しています。
      テキストは普通のHTMLテキストに変換し、
      それ以外のものは添付ファイルとしてリストするようにしています。
      
    </div>
  </body>
</html>
